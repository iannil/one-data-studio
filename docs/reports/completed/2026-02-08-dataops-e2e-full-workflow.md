# DataOps 全流程 E2E 测试实施记录

**日期**: 2026-02-08
**任务**: 创建 DataOps 平台从数据接入到数据利用的完整 E2E 测试

---

## 完成内容

### 1. 创建的文件

| 文件 | 说明 |
|------|------|
| `tests/e2e/data-ops/full-workflow.spec.ts` | DataOps 全流程 E2E 测试脚本 |
| `run-dataops-e2e.sh` | 测试运行脚本 |
| `docs/07-operations/dataops-e2e-guide.md` | 测试使用指南 |

### 2. 测试覆盖流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DataOps 全流程测试                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  阶段1: 数据接入 (5个测试)                                                  │
│  ├── 1.1 访问数据源管理页面                                                │
│  ├── 1.2 打开新建数据源对话框                                              │
│  ├── 1.3 填写数据源配置信息                                                │
│  ├── 1.4 测试数据源连接                                                    │
│  └── 1.5 创建数据源                                                        │
│                                                                             │
│  阶段2: 数据处理 (3个测试)                                                  │
│  ├── 2.1 访问 ETL 管理页面                                                 │
│  ├── 2.2 创建 ETL 任务                                                     │
│  └── 2.3 配置字段映射                                                      │
│                                                                             │
│  阶段3: 数据治理 (5个测试)                                                  │
│  ├── 3.1 访问元数据管理页面                                                │
│  ├── 3.2 浏览数据库和表结构                                                │
│  ├── 3.3 执行 AI 智能标注                                                  │
│  ├── 3.4 执行敏感数据扫描                                                  │
│  └── 3.5 搜索表和字段                                                      │
│                                                                             │
│  阶段4: 数据利用 (4个测试)                                                  │
│  ├── 4.1 访问 Text-to-SQL 页面                                             │
│  ├── 4.2 执行自然语言查询                                                  │
│  ├── 4.3 访问 BI 报表页面                                                  │
│  └── 4.4 访问数据服务页面                                                  │
│                                                                             │
│  完整流程验证 (1个测试)                                                     │
│  └── 生成完整流程报告                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3. 运行测试

```bash
# 使用运行脚本
./run-dataops-e2e.sh

# 或直接使用 Playwright
npx playwright test --project=data-ops-full full-workflow --reporter=list

# 查看测试报告
npx playwright show-report
```

### 4. 测试输出

- **控制台输出**: 每个步骤的执行状态
- **截图**: `test-results/dataops/*.png`
- **HTML 报告**: `playwright-report/index.html`

### 5. 测试示例输出

```
=================================
DataOps 全流程测试汇总
=================================
✓ 可访问 数据源管理
✓ 可访问 ETL 管理
✓ 可访问 数据质量
✓ 可访问 元数据管理
✓ 可访问 数据血缘
✓ 可访问 BI 报表
✓ 可访问 数据服务
=================================

✓ 完整流程验证完成
```

---

## 技术要点

### 页面访问模式
- 使用 `page.locator()` 配合 `.or()` 方法实现灵活的元素定位
- 支持中英文两种 UI 文本匹配
- 使用 `await expect().toBeVisible()` 验证页面元素

### 截图记录
- 每个关键步骤都保存截图
- 使用编号命名便于追溯
- 失败时自动保存错误截图

### 测试隔离
- 每个测试独立运行，可单独调试
- 使用 `workers=1` 串行执行避免状态冲突

---

## 待优化项

| 项目 | 状态 | 说明 |
|------|------|------|
| 认证集成 | 待完成 | 当前测试跳过认证，需要支持 Keycloak 登录 |
| 真实数据源 | 待配置 | 需要配置测试用的 MySQL 数据源 |
| API Mock | 部分完成 | 部分测试使用真实 API，部分使用 Mock |
| 断言增强 | 待优化 | 需要增加更多断言验证实际功能 |

---

## 新增功能 (2026-02-08)

### 元数据版本管理 - 创建快照功能

**问题**: 版本对比页面缺少"创建快照"按钮

**解决方案**: 在 `web/src/components/metadata/MetadataVersionDiff.tsx` 中添加了创建快照功能

#### 实现内容

1. **创建快照按钮** (`SnapshotsTab` 组件)
   - 添加"创建快照"按钮，点击打开创建表单模态框
   - 按钮位置：快照列表卡片的 extra 区域，与"对比选中快照"按钮并列

2. **创建快照表单** (`CreateSnapshotForm` 组件)
   ```tsx
   - 版本号：必填，支持字母、数字、点、下划线、连字符
   - 数据库：可选，下拉选择（自动获取可用数据库列表）
   - 描述：可选，最多500字符，记录版本变更内容
   - 提交：调用 createMetadataSnapshot API
   ```

3. **状态刷新**
   - 创建成功后自动刷新快照列表
   - 同时刷新版本历史数据
   - 显示成功/失败提示消息

#### 修改的文件

| 文件 | 修改内容 |
|------|----------|
| `web/src/components/metadata/MetadataVersionDiff.tsx` | 添加 CreateSnapshotForm 组件 (110+ 行) |

#### 使用方式

访问 http://localhost:3000/metadata/version-diff，点击"创建快照"按钮：

---

## 相关文档

- [DataOps 全流程 E2E 测试指南](../../07-operations/dataops-e2e-guide.md)
- [DataOps 平台概述](../../01-architecture/platform-overview.md)
- [测试计划](../../04-testing/test-plan.md)
