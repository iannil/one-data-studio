# 数据接入测试规范

> 功能数: 20 | 模块数: 3
> 领域: 一、数据接入

本文档定义数据接入领域所有功能的测试规范，包含数据源管理、CDC 变更数据捕获、文件上传三个模块。

---

## 目录

- [1.1 数据源管理 (DS)](#11-数据源管理-ds)
- [1.2 CDC 变更数据捕获 (CDC)](#12-cdc-变更数据捕获-cdc)
- [1.3 文件上传 (FU)](#13-文件上传-fu)

---

## 1.1 数据源管理 (DS)

**后端代码**: `services/data-api/models/datasource.py`
**前端代码**: `web/src/pages/data/datasources/DataSourcesPage.tsx`

### DS-001 数据源列表查询

**实现目标**: 分页查询数据源列表，支持按类型和状态筛选，为用户提供数据源的全局视图

**测试步骤**:
1. 登录系统，进入数据管理 > 数据源管理页面
2. 验证列表正常加载，显示数据源名称、类型、状态、连接信息等字段
3. 使用类型下拉筛选器选择 MySQL 类型
4. 验证列表仅显示 MySQL 类型的数据源
5. 使用状态筛选器选择 connected 状态
6. 验证列表仅显示已连接的数据源
7. 测试分页功能：切换到第 2 页，验证数据正确加载
8. 测试每页条数切换：选择 20 条/页，验证显示数量正确

**成功条件**:
- 列表正确显示所有数据源信息
- 类型筛选结果仅包含选定类型
- 状态筛选结果仅包含选定状态
- 分页导航正常工作
- 总数统计准确

**失败条件**:
- 列表加载失败或显示空白
- 筛选条件不生效
- 分页切换后数据不变化
- 数据源信息显示不完整或错误

---

### DS-002 数据源创建

**实现目标**: 创建新的数据源连接，支持 MySQL、PostgreSQL、Oracle、SQL Server、Hive、MongoDB、Redis、Elasticsearch 等多种类型

**测试步骤**:
1. 进入数据源管理页面，点击"新建数据源"按钮
2. 选择数据源类型（如 MySQL）
3. 填写基本信息：名称、描述、标签
4. 填写连接配置：主机地址、端口（3306）、数据库名、用户名、密码
5. 点击"测试连接"验证配置正确
6. 点击"保存"创建数据源
7. 验证数据源出现在列表中
8. 重复测试其他数据源类型（PostgreSQL、MongoDB 等）

**成功条件**:
- 数据源创建成功，返回新建的数据源 ID
- 新数据源在列表中可见
- 连接测试通过
- 支持所有声明的数据源类型
- 必填字段校验正常

**失败条件**:
- 创建失败或抛出异常
- 连接信息保存不完整
- 不支持声明的数据源类型
- 必填字段为空时未提示错误

---

### DS-003 数据源编辑

**实现目标**: 修改已有数据源的配置信息，包括连接参数、描述、标签等

**测试步骤**:
1. 进入数据源管理页面，在列表中选择一个数据源
2. 点击"编辑"按钮或行内编辑图标
3. 修改数据源名称
4. 修改连接配置（如更改端口号）
5. 修改标签
6. 点击"测试连接"验证新配置
7. 点击"保存"提交修改
8. 验证修改后的信息在列表中正确显示

**成功条件**:
- 编辑表单正确加载原有配置
- 修改后保存成功
- 列表显示更新后的信息
- 连接测试反映新配置

**失败条件**:
- 原有配置加载错误
- 修改后保存失败
- 列表信息未更新
- 密码等敏感信息被错误清空

---

### DS-004 数据源删除

**实现目标**: 删除指定的数据源，支持单个删除和批量删除

**测试步骤**:
1. 进入数据源管理页面
2. 选择一个未被引用的数据源
3. 点击"删除"按钮
4. 确认删除对话框，点击"确定"
5. 验证数据源从列表中消失
6. 尝试删除一个被 ETL 任务引用的数据源
7. 验证系统提示无法删除

**成功条件**:
- 未被引用的数据源可以成功删除
- 删除后列表立即更新
- 被引用的数据源提示无法删除，显示引用关系
- 删除操作记录审计日志

**失败条件**:
- 删除操作失败
- 删除后列表未更新
- 被引用的数据源被强制删除导致任务失败
- 未显示删除确认对话框

---

### DS-005 连接测试

**实现目标**: 测试数据源连接是否可用，验证配置的正确性

**测试步骤**:
1. 创建或编辑数据源时，填写连接配置
2. 点击"测试连接"按钮
3. 使用正确的配置测试，验证显示"连接成功"
4. 使用错误的密码测试，验证显示"连接失败"及错误原因
5. 使用不可达的主机测试，验证超时处理
6. 测试不同数据源类型的连接

**成功条件**:
- 正确配置显示"连接成功"
- 错误配置显示明确的错误信息
- 连接超时有合理的等待时间（如 30 秒）
- 支持所有数据源类型的连接测试

**失败条件**:
- 正确配置显示连接失败
- 错误原因不明确或显示技术性错误
- 连接测试长时间无响应
- 某些数据源类型无法测试

---

### DS-006 状态管理

**实现目标**: 管理数据源的连接状态，支持 connected、disconnected、error 三种状态

**测试步骤**:
1. 查看数据源列表，确认状态列正确显示
2. 手动断开数据源连接，验证状态变为 disconnected
3. 重新连接数据源，验证状态变为 connected
4. 模拟数据库服务不可用，验证状态变为 error
5. 恢复数据库服务，验证状态自动或手动恢复

**成功条件**:
- 状态显示准确反映实际连接情况
- 状态切换操作成功
- error 状态显示错误详情
- 状态变更记录日志

**失败条件**:
- 状态显示与实际不符
- 状态切换操作失败
- error 状态无错误详情
- 状态一直显示 unknown

---

### DS-007 标签管理

**实现目标**: 为数据源添加、删除标签，支持按标签筛选

**测试步骤**:
1. 编辑数据源，添加标签（如"生产环境"、"核心业务"）
2. 保存并验证标签显示正确
3. 在列表页按标签筛选数据源
4. 验证筛选结果正确
5. 编辑数据源，删除某个标签
6. 验证标签删除成功

**成功条件**:
- 标签添加成功并显示
- 标签筛选结果正确
- 标签删除成功
- 支持多标签

**失败条件**:
- 标签保存失败
- 标签筛选无效
- 标签显示异常
- 不支持特殊字符标签

---

### DS-008 元数据采集

**实现目标**: 自动采集数据源的元数据信息，包括表数量、数据库版本、字符集等

**测试步骤**:
1. 创建一个新的 MySQL 数据源
2. 等待系统自动采集元数据
3. 查看数据源详情，验证显示表数量
4. 验证显示数据库版本信息
5. 手动触发元数据刷新
6. 验证元数据更新成功

**成功条件**:
- 自动采集表数量正确
- 数据库版本信息准确
- 手动刷新功能正常
- 采集时间戳记录正确

**失败条件**:
- 元数据采集失败
- 表数量显示为 0 或错误
- 版本信息不准确
- 无法手动刷新

---

## 1.2 CDC 变更数据捕获 (CDC)

**后端代码**: `services/data-api/routes/cdc.py`, `services/data-api/services/cdc_service.py`
**前端代码**: `web/src/pages/data/cdc/CDCManagementPage.tsx`

### CDC-001 CDC 任务创建

**实现目标**: 创建 CDC 同步任务，配置源端和目标端，实现增量数据实时同步

**测试步骤**:
1. 进入 CDC 管理页面，点击"创建任务"
2. 填写任务名称和描述
3. 选择源数据源（MySQL）和源表
4. 选择目标端（如 ClickHouse）和目标表
5. 配置同步参数（是否同步 DDL、初始快照等）
6. 保存任务配置
7. 验证任务创建成功

**成功条件**:
- 任务创建成功，返回任务 ID
- 任务在列表中可见
- 配置信息保存正确
- 源表和目标表映射正确

**失败条件**:
- 任务创建失败
- 配置信息丢失
- 源端或目标端连接配置错误
- 表映射不正确

---

### CDC-002 CDC 任务列表

**实现目标**: 查看所有 CDC 任务列表，显示任务状态、同步进度等信息

**测试步骤**:
1. 进入 CDC 管理页面
2. 验证列表显示所有任务
3. 验证显示任务名称、状态、源端、目标端
4. 验证显示同步进度和最后同步时间
5. 测试列表筛选功能
6. 测试列表排序功能

**成功条件**:
- 列表正确显示所有任务
- 任务状态实时更新
- 同步进度显示准确
- 筛选和排序功能正常

**失败条件**:
- 列表加载失败
- 任务状态不更新
- 进度显示不准确
- 列表为空但实际有任务

---

### CDC-003 CDC 任务详情

**实现目标**: 获取 CDC 任务的完整配置和运行指标，支持任务诊断

**测试步骤**:
1. 在任务列表点击某个任务进入详情页
2. 验证显示任务基本信息
3. 验证显示源端和目标端配置
4. 验证显示同步规则配置
5. 验证显示运行指标（同步延迟、TPS 等）
6. 验证显示错误日志（如有）

**成功条件**:
- 详情页面加载完整
- 配置信息显示正确
- 运行指标实时更新
- 错误信息清晰可读

**失败条件**:
- 详情页加载失败
- 配置信息不完整
- 指标数据不更新
- 无法查看错误日志

---

### CDC-004 CDC 任务启动

**实现目标**: 启动 CDC 任务，开始增量数据同步

**测试步骤**:
1. 在任务列表选择一个已停止的任务
2. 点击"启动"按钮
3. 验证任务状态变为 running
4. 在源端插入一条测试数据
5. 验证数据同步到目标端
6. 验证运行指标开始更新

**成功条件**:
- 任务启动成功
- 状态正确显示为 running
- 数据能够实时同步
- 指标数据正常采集

**失败条件**:
- 任务启动失败
- 状态显示错误
- 数据未同步
- 指标为零或不更新

---

### CDC-005 CDC 任务停止

**实现目标**: 停止 CDC 任务，暂停数据同步

**测试步骤**:
1. 在任务列表选择一个运行中的任务
2. 点击"停止"按钮
3. 验证任务状态变为 stopped
4. 验证同步进程停止
5. 验证停止后的位点信息被保存
6. 重新启动验证从上次位点继续同步

**成功条件**:
- 任务停止成功
- 状态正确显示为 stopped
- 位点信息正确保存
- 重启后可断点续传

**失败条件**:
- 任务无法停止
- 状态显示异常
- 位点信息丢失
- 重启后从头开始同步

---

### CDC-006 CDC 任务删除

**实现目标**: 删除 CDC 任务及其配置信息

**测试步骤**:
1. 停止一个运行中的任务
2. 点击"删除"按钮
3. 确认删除对话框
4. 验证任务从列表中移除
5. 验证相关配置数据被清理
6. 尝试删除运行中的任务，验证系统提示

**成功条件**:
- 已停止的任务可以删除
- 任务及配置完全清理
- 运行中任务提示需先停止
- 删除操作记录日志

**失败条件**:
- 删除失败
- 配置数据残留
- 运行中任务被强制删除
- 无删除确认步骤

---

### CDC-007 运行指标查询

**实现目标**: 获取 CDC 任务的实时运行指标，包括同步延迟、TPS、处理行数等

**测试步骤**:
1. 启动一个 CDC 任务
2. 进入任务详情的监控面板
3. 验证显示同步延迟（秒）
4. 验证显示每秒处理行数（TPS）
5. 验证显示累计处理行数
6. 验证显示错误数量
7. 测试指标数据刷新

**成功条件**:
- 指标数据准确
- 延迟指标反映真实同步延迟
- TPS 计算正确
- 指标实时更新

**失败条件**:
- 指标数据为空
- 延迟显示不准确
- TPS 数值异常
- 指标长时间不更新

---

### CDC-008 MySQL-MinIO 模板

**实现目标**: 使用预置模板快速创建 MySQL 到 MinIO 的 CDC 同步任务

**测试步骤**:
1. 进入 CDC 任务创建页面
2. 选择"MySQL-MinIO"模板
3. 验证自动填充源端类型和目标端类型
4. 填写源 MySQL 连接信息
5. 填写目标 MinIO 配置（bucket、路径、格式）
6. 完成任务创建
7. 启动任务验证数据同步到 MinIO

**成功条件**:
- 模板正确预填配置
- 任务创建成功
- 数据正确写入 MinIO
- 文件格式符合配置

**失败条件**:
- 模板不存在或加载失败
- 预填配置不完整
- 数据无法写入 MinIO
- 文件格式错误

---

### CDC-009 MySQL-ClickHouse 模板

**实现目标**: 使用预置模板快速创建 MySQL 到 ClickHouse 的 CDC 同步任务

**测试步骤**:
1. 进入 CDC 任务创建页面
2. 选择"MySQL-ClickHouse"模板
3. 验证自动填充源端和目标端类型
4. 填写源 MySQL 连接和表信息
5. 填写目标 ClickHouse 连接和表信息
6. 配置字段映射
7. 完成任务创建并启动
8. 验证数据同步到 ClickHouse

**成功条件**:
- 模板正确预填配置
- 任务创建成功
- 增删改操作正确同步
- ClickHouse 数据准确

**失败条件**:
- 模板加载失败
- 字段映射错误
- 数据同步不完整
- ClickHouse 写入失败

---

## 1.3 文件上传 (FU)

**后端代码**: `services/data-api/models/file_upload.py`

### FU-001 文件上传

**实现目标**: 上传数据文件到平台，支持 CSV、Excel、JSON 等格式

**测试步骤**:
1. 进入数据导入页面
2. 点击"上传文件"或拖拽文件到上传区域
3. 上传一个 CSV 文件（<10MB）
4. 验证上传进度显示
5. 验证上传完成后文件在列表中显示
6. 上传一个 Excel 文件（.xlsx）
7. 上传一个 JSON 文件
8. 测试上传大文件（>100MB）

**成功条件**:
- 文件上传成功
- 进度条正确显示
- 支持 CSV/Excel/JSON 格式
- 大文件分片上传正常

**失败条件**:
- 文件上传失败
- 进度显示不准确
- 不支持声明的文件格式
- 大文件上传超时或失败

---

### FU-002 文件解析

**实现目标**: 自动解析上传文件的结构，识别字段名称和数据类型

**测试步骤**:
1. 上传一个带表头的 CSV 文件
2. 验证系统自动识别列名
3. 验证系统推断数据类型（字符串、数字、日期）
4. 上传一个 Excel 文件，验证多 Sheet 解析
5. 上传一个嵌套 JSON 文件，验证结构解析
6. 修改推断的字段类型
7. 确认解析结果

**成功条件**:
- 列名正确识别
- 数据类型推断合理
- Excel 多 Sheet 支持
- JSON 嵌套结构正确解析
- 支持手动修正类型

**失败条件**:
- 列名识别错误
- 数据类型推断不准确
- Excel 只能解析第一个 Sheet
- JSON 解析失败
- 无法修改推断结果

---

### FU-003 文件预览

**实现目标**: 预览上传文件的内容，在导入前确认数据正确性

**测试步骤**:
1. 上传一个 CSV 文件
2. 点击"预览"查看文件内容
3. 验证显示前 N 行数据（如前 100 行）
4. 验证列名显示在表头
5. 验证数据格式正确显示
6. 测试分页浏览更多数据
7. 测试预览大文件的响应速度

**成功条件**:
- 预览数据正确显示
- 列名和数据对齐
- 分页功能正常
- 大文件预览响应及时

**失败条件**:
- 预览加载失败
- 数据显示乱码
- 列名与数据错位
- 大文件预览卡死

---

## 统计汇总

| 模块 | 功能数 | 功能编号范围 |
|------|--------|-------------|
| 数据源管理 (DS) | 8 | DS-001 ~ DS-008 |
| CDC 变更数据捕获 (CDC) | 9 | CDC-001 ~ CDC-009 |
| 文件上传 (FU) | 3 | FU-001 ~ FU-003 |
| **总计** | **20** | |

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| 1.0.0 | 2026-02-09 | 初始版本 |
