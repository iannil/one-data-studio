# 四层架构设计

## 总体架构

我们将平台划分为四层架构，采用**微服务 + 容器化**部署方式，底层依赖 Kubernetes 进行统一资源调度。

```
┌─────────────────────────────────────────────────────────────────┐
│                     L4 应用编排层 (Agent)                      │
│                  RAG 流水线 | Agent 编排 | Prompt 管理             │
└─────────────────────────────────────────────────────────────────┘
                              ↕ OpenAI API / 元数据
┌─────────────────────────────────────────────────────────────────┐
│                    L3 算法引擎层 (Model)                   │
│            Notebook | 分布式训练 | 模型仓库 | 模型服务化           │
└─────────────────────────────────────────────────────────────────┘
                              ↕ 挂载数据卷
┌─────────────────────────────────────────────────────────────────┐
│                    L2 数据底座层 (Data)                       │
│          数据集成 | ETL | 数据治理 | 特征存储 | 向量存储           │
└─────────────────────────────────────────────────────────────────┘
                              ↕ 存储协议
┌─────────────────────────────────────────────────────────────────┐
│                    L1 基础设施层 (K8s)                           │
│              CPU/GPU 资源池 | 存储 | 网络 | 监控                  │
└─────────────────────────────────────────────────────────────────┘
```

## L1 基础设施层 (Infrastructure Layer)

### 核心组件
* **Kubernetes (K8s)**：容器编排与调度
* **Docker/Containerd**：容器运行时

### 资源池
* **CPU 节点**：用于 ETL 任务、Web 服务
* **GPU 节点**：用于模型训练、推理加速
* **存储**：S3/MinIO（对象存储）、HDFS（分布式存储）、PVC（持久卷）

### 功能
* Model 的基础组件（Volcano/Ray）在此层负责异构算力的调度
* 通过 Namespace 实现多租户资源隔离

## L2 数据底座层 (Data Foundation - Data Core)

### 功能模块
* **数据集成**：连接多种数据源（数据库、文件、API）
* **离线/实时开发**：ETL 任务开发与调度
* **数据治理**：元数据管理、数据质量、血缘追踪

### 集成点
* **Feature Store（特征存储）**：统一管理训练特征
* **Vector Store（向量存储）**：管理向量化知识库

### 技术支撑
* **Flink/Spark**：流批一体数据处理引擎
* **DataX/SeaTunnel**：数据同步工具
* **Atlas/DataHub**：元数据管理
* **DolphinScheduler**：任务调度

## L3 算法引擎层 (Model Engine - Model Core)

### 功能模块
* **Notebook 交互式开发**：JupyterLab 在线开发环境
* **分布式训练任务**：支持 PyTorch、TensorFlow 分布式训练
* **模型仓库**：模型版本管理与追踪
* **模型服务化（Serving）**：一键部署模型为 API

### 集成点
* **向下**：直接挂载 L2 层处理好的数据卷
* **向上**：向 L4 层暴露兼容 OpenAI 协议的 API 接口

### 技术支撑
* **JupyterHub**：多租户 Notebook 环境
* **PyTorch/TensorFlow**：深度学习框架
* **MPI/Horovod**：分布式训练
* **Istio/Knative**：推理服务网关
* **vLLM/TensorRT-LLM**：高性能推理引擎

## L4 应用编排层 (Application Layer - Agent Core)

### 功能模块
* **RAG 检索流程**：文档解析、向量化、检索
* **Agent 逻辑编排**：多步骤任务编排
* **Prompt 管理**：提示词版本管理
* **前端应用生成**：低代码应用构建

### 集成点
* **调用 L3**：使用模型 API 进行推理
* **调用 L2**：查询结构化数据库（Text-to-SQL）

### 技术支撑
* **LangChain/LlamaIndex**：LLM 应用框架
* **Flowise**：可视化流程编排
* **向量数据库连接器**：Milvus、PgVector 等
* **Unstructured.io**：文档解析引擎

## 层间交互

### L2 → L3：数据驱动训练
* Data 完成 ETL 后，数据写入对象存储
* 自动注册数据集到 Model
* 训练任务直接挂载数据集，无需重复搬运

### L3 → L4：模型即服务
* Model 部署模型为 OpenAI 兼容 API
* Agent 配置自定义模型端点
- 弹性伸缩支持高并发推理

### L2 → L4：知识增强查询
* Data 提供元数据用于 Text-to-SQL
* Data 管理向量数据库用于 RAG 检索
* Agent 统一调用两类数据源
