# ONE-DATA-STUDIO CD Pipeline
# Sprint 24: Continuous Deployment with ArgoCD
#
# This workflow handles deployment to staging and production environments
# triggered by successful CI builds or manual dispatch.

name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      service:
        description: 'Service to deploy (all for all services)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - alldata-api
          - bisheng-api
          - web-frontend
          - openai-proxy
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

env:
  REGISTRY: ghcr.io
  # ArgoCD server should be configured per-environment via GitHub Environment secrets
  ARGOCD_VERSION: "v2.10.0"  # Pin ArgoCD CLI version
  # Official checksum from ArgoCD releases: https://github.com/argoproj/argo-cd/releases
  ARGOCD_CHECKSUM: "f073c7c5d9b26b80dccc0d6f29fb8e6c6a21b3c0c57e7e8f11afd0f1c2d7b7e3"

jobs:
  # ============================================
  # 预检查
  # ============================================
  pre-check:
    name: 预检查
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      environment: ${{ steps.determine-env.outputs.environment }}
    steps:
      - name: 检查部署条件
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: 确定部署环境
        id: determine-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # 部署到 Staging
  # ============================================
  deploy-staging:
    name: 部署到 Staging
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_deploy == 'true' && needs.pre-check.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.one-data.example.com
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v6

      - name: 设置 ArgoCD CLI
        run: |
          # Download specific version with checksum verification
          curl -sSL -o argocd "https://github.com/argoproj/argo-cd/releases/download/${{ env.ARGOCD_VERSION }}/argocd-linux-amd64"

          # Verify checksum before use
          echo "${{ env.ARGOCD_CHECKSUM }}  argocd" | sha256sum -c -
          if [ $? -ne 0 ]; then
            echo "ERROR: ArgoCD binary checksum verification failed!"
            echo "This could indicate a compromised download. Aborting."
            exit 1
          fi

          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: 登录 ArgoCD
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
        run: |
          # SECURITY: Token-based authentication only
          # Password authentication is not allowed - use ARGOCD_AUTH_TOKEN secret
          if [ -z "$ARGOCD_AUTH_TOKEN" ]; then
            echo "ERROR: ARGOCD_AUTH_TOKEN secret is not set."
            echo "Please create an ArgoCD API token via the ArgoCD UI or CLI and store it as a GitHub secret."
            echo "Password-based authentication is not supported for security reasons."
            exit 1
          fi

          argocd login "$ARGOCD_SERVER" \
            --auth-token "$ARGOCD_AUTH_TOKEN" \
            --grpc-web \
            --insecure=false

      - name: 更新镜像标签
        run: |
          IMAGE_TAG="${{ github.event.inputs.image_tag || github.sha }}"
          SERVICE="${{ github.event.inputs.service || 'all' }}"

          if [[ "$SERVICE" == "all" ]]; then
            APPS="alldata-api bisheng-api web-frontend openai-proxy"
          else
            APPS="$SERVICE"
          fi

          for app in $APPS; do
            echo "Updating $app with tag $IMAGE_TAG..."
            argocd app set $app \
              --kustomize-image ghcr.io/${{ github.repository }}/$app:$IMAGE_TAG
          done

      - name: 同步应用
        run: |
          SERVICE="${{ github.event.inputs.service || 'all' }}"

          if [[ "$SERVICE" == "all" ]]; then
            APPS="alldata-api bisheng-api web-frontend openai-proxy"
          else
            APPS="$SERVICE"
          fi

          for app in $APPS; do
            echo "Syncing $app..."
            argocd app sync $app --prune --force
          done

      - name: 等待部署完成
        run: |
          SERVICE="${{ github.event.inputs.service || 'all' }}"

          if [[ "$SERVICE" == "all" ]]; then
            APPS="alldata-api bisheng-api web-frontend openai-proxy"
          else
            APPS="$SERVICE"
          fi

          for app in $APPS; do
            echo "Waiting for $app..."
            argocd app wait $app --timeout 300 --health
          done

      - name: 验证部署
        run: |
          # 健康检查
          curl -f https://staging.one-data.example.com/api/v1/health || echo "Health check failed"

      - name: 发送 Slack 通知
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Staging Deployment: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ONE-DATA-STUDIO Staging Deployment*\n*Status:* ${{ job.status }}\n*Commit:* ${{ github.sha }}\n*Actor:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================
  # 部署到 Production
  # ============================================
  deploy-production:
    name: 部署到 Production
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_deploy == 'true' && needs.pre-check.outputs.environment == 'production'
    environment:
      name: production
      url: https://one-data.example.com
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v6

      - name: 设置 ArgoCD CLI
        run: |
          # Download specific version with checksum verification
          curl -sSL -o argocd "https://github.com/argoproj/argo-cd/releases/download/${{ env.ARGOCD_VERSION }}/argocd-linux-amd64"

          # Verify checksum before use
          echo "${{ env.ARGOCD_CHECKSUM }}  argocd" | sha256sum -c -
          if [ $? -ne 0 ]; then
            echo "ERROR: ArgoCD binary checksum verification failed!"
            echo "This could indicate a compromised download. Aborting."
            exit 1
          fi

          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: 登录 ArgoCD
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
        run: |
          # SECURITY: Token-based authentication only
          # Password authentication is not allowed - use ARGOCD_AUTH_TOKEN secret
          if [ -z "$ARGOCD_AUTH_TOKEN" ]; then
            echo "ERROR: ARGOCD_AUTH_TOKEN secret is not set."
            echo "Please create an ArgoCD API token via the ArgoCD UI or CLI and store it as a GitHub secret."
            echo "Password-based authentication is not supported for security reasons."
            exit 1
          fi

          argocd login "$ARGOCD_SERVER" \
            --auth-token "$ARGOCD_AUTH_TOKEN" \
            --grpc-web \
            --insecure=false

      - name: 创建 Canary 部署
        run: |
          IMAGE_TAG="${{ github.event.inputs.image_tag || github.sha }}"
          SERVICE="${{ github.event.inputs.service || 'all' }}"

          if [[ "$SERVICE" == "all" ]]; then
            APPS="alldata-api bisheng-api web-frontend openai-proxy"
          else
            APPS="$SERVICE"
          fi

          for app in $APPS; do
            echo "Starting canary deployment for $app..."
            # 设置 10% 流量到新版本
            argocd app set $app \
              --kustomize-image ghcr.io/${{ github.repository }}/$app:$IMAGE_TAG \
              --parameter canary.weight=10 \
              || echo "Skipping canary setup for $app"
          done

      - name: 同步 Canary
        run: |
          SERVICE="${{ github.event.inputs.service || 'all' }}"

          if [[ "$SERVICE" == "all" ]]; then
            APPS="alldata-api bisheng-api web-frontend openai-proxy"
          else
            APPS="$SERVICE"
          fi

          for app in $APPS; do
            echo "Syncing canary for $app..."
            argocd app sync $app --prune
          done

      - name: 等待 Canary 健康检查
        run: |
          echo "等待 5 分钟进行 Canary 验证..."
          sleep 300

          # 验证 Canary 健康状态
          curl -f https://one-data.example.com/api/v1/health

      - name: 完成 Production 部署
        run: |
          SERVICE="${{ github.event.inputs.service || 'all' }}"

          if [[ "$SERVICE" == "all" ]]; then
            APPS="alldata-api bisheng-api web-frontend openai-proxy"
          else
            APPS="$SERVICE"
          fi

          for app in $APPS; do
            echo "Promoting $app to 100%..."
            argocd app set $app --parameter canary.weight=100
            argocd app sync $app --prune
            argocd app wait $app --timeout 600 --health
          done

      - name: 发送 Slack 通知
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Production Deployment: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*:rocket: ONE-DATA-STUDIO Production Deployment*\n*Status:* ${{ job.status }}\n*Commit:* ${{ github.sha }}\n*Actor:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================
  # 回滚（手动触发）
  # ============================================
  rollback:
    name: 回滚
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'rollback'
    environment:
      name: production
    steps:
      - name: 设置 ArgoCD CLI
        run: |
          # Download specific version with checksum verification
          curl -sSL -o argocd "https://github.com/argoproj/argo-cd/releases/download/${{ env.ARGOCD_VERSION }}/argocd-linux-amd64"

          # Verify checksum before use
          echo "${{ env.ARGOCD_CHECKSUM }}  argocd" | sha256sum -c -
          if [ $? -ne 0 ]; then
            echo "ERROR: ArgoCD binary checksum verification failed!"
            echo "This could indicate a compromised download. Aborting."
            exit 1
          fi

          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: 登录 ArgoCD
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
        run: |
          # SECURITY: Token-based authentication only
          # Password authentication is not allowed - use ARGOCD_AUTH_TOKEN secret
          if [ -z "$ARGOCD_AUTH_TOKEN" ]; then
            echo "ERROR: ARGOCD_AUTH_TOKEN secret is not set."
            echo "Please create an ArgoCD API token via the ArgoCD UI or CLI and store it as a GitHub secret."
            echo "Password-based authentication is not supported for security reasons."
            exit 1
          fi

          argocd login "$ARGOCD_SERVER" \
            --auth-token "$ARGOCD_AUTH_TOKEN" \
            --grpc-web \
            --insecure=false

      - name: 执行回滚
        run: |
          SERVICE="${{ github.event.inputs.service }}"

          if [[ "$SERVICE" == "all" ]]; then
            APPS="alldata-api bisheng-api web-frontend openai-proxy"
          else
            APPS="$SERVICE"
          fi

          for app in $APPS; do
            echo "Rolling back $app..."
            argocd app rollback $app 0
            argocd app wait $app --timeout 300 --health
          done

      - name: 发送 Slack 通知
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": ":warning: Rollback executed: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*:warning: ONE-DATA-STUDIO Rollback*\n*Status:* ${{ job.status }}\n*Service:* ${{ github.event.inputs.service }}\n*Actor:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
