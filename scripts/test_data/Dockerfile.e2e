# =============================================================================
# ONE-DATA-STUDIO E2E 测试数据生成器 Dockerfile
# =============================================================================
#
# 功能：生成 E2E 测试所需的 20,000+ 条测试数据
#
# 使用方法：
#   docker build -f Dockerfile.e2e -t e2e-data-generator .
#   docker run --rm --network e2e-network e2e-data-generator
#
# =============================================================================

FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    default-mysql-client \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# 复制 requirements 文件（如果存在）
COPY requirements.txt ./

# 安装 Python 依赖
RUN pip install --no-cache-dir \
    pymysql==1.1.0 \
    psycopg2-binary==2.9.9 \
    faker==20.1.0 \
    requests==2.31.0

# 复制测试数据生成脚本
COPY generate_test_data.py ./
COPY init_e2e_mysql.sql ./
COPY init_e2e_postgres.sql ./

# 设置环境变量默认值
ENV MYSQL_HOST=mysql-e2e
ENV MYSQL_PORT=3306
ENV MYSQL_USER=root
ENV MYSQL_PASSWORD=e2eroot123
ENV POSTGRES_HOST=postgres-e2e
ENV POSTGRES_PORT=5432
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=e2epostgres123
ENV DATA_COUNT=20000
ENV USER_COUNT=1500
ENV PRODUCT_COUNT=800
ENV ORDER_COUNT=2500
ENV ORDER_ITEM_COUNT=5000
ENV LOG_COUNT=10000

# 创建启动脚本
RUN echo '#!/bin/bash\n\
set -e\n\
echo "============================================"\n\
echo "E2E Test Data Generator"\n\
echo "============================================"\n\
echo "Starting data generation..."\n\
echo ""\n\
echo "Waiting for databases to be ready..."\n\
sleep 10\n\
echo ""\n\
echo "Generating MySQL test data..."\n\
python generate_test_data.py --db mysql --count ${DATA_COUNT} \\\n\
    --mysql-host ${MYSQL_HOST} \\\n\
    --mysql-port ${MYSQL_PORT} \\\n\
    --mysql-user ${MYSQL_USER} \\\n\
    --mysql-password ${MYSQL_PASSWORD} \\\n\
    --verbose || echo "MySQL data generation failed"\n\
echo ""\n\
echo "Generating PostgreSQL test data..."\n\
python generate_test_data.py --db postgres --count $((DATA_COUNT/2)) \\\n\
    --postgres-host ${POSTGRES_HOST} \\\n\
    --postgres-port ${POSTGRES_PORT} \\\n\
    --postgres-user ${POSTGRES_USER} \\\n\
    --postgres-password ${POSTGRES_PASSWORD} \\\n\
    --verbose || echo "PostgreSQL data generation failed"\n\
echo ""\n\
echo "============================================"\n\
echo "Data generation completed!"\n\
echo "============================================"\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# 设置入口点
ENTRYPOINT ["/app/entrypoint.sh"]

# 设置默认命令
CMD []
