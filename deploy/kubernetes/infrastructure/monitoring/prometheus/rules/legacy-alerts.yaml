# ONE-DATA-STUDIO AlertManager 规则配置
# Sprint 13.2: 高级监控 - 告警规则

groups:
  - name: one-data-studio-api
    rules:
      # API 响应时间过高
      - alert: APIHighLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="agent-api"}[5m])) by (le, path)) > 0.5
        for: 5m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "API 响应时间过高"
          description: "API 路径 {{ $labels.path }} 的 P95 响应时间超过 500ms (当前值: {{ $value | printf \"%.2f\" }}s)"

      # API 错误率过高
      - alert: APIHighErrorRate
        expr: sum(rate(http_requests_total{service="agent-api", status=~"5.."}[5m])) / sum(rate(http_requests_total{service="agent-api"}[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
          service: agent-api
        annotations:
          summary: "API 错误率过高"
          description: "Agent API 5xx 错误率超过 5% (当前值: {{ $value | printf \"%.2f\" }}%)"

      # API 请求量异常
      - alert: APIRequestSpikeOrDrop
        expr: |
          abs(
            sum(rate(http_requests_total{service="agent-api"}[5m]))
            - sum(rate(http_requests_total{service="agent-api"}[5m] offset 1h))
          ) / sum(rate(http_requests_total{service="agent-api"}[5m] offset 1h)) > 0.5
        for: 10m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "API 请求量异常波动"
          description: "Agent API 请求量与 1 小时前相比变化超过 50%"

  - name: one-data-studio-database
    rules:
      # 数据库连接池耗尽
      - alert: DatabaseConnectionPoolExhausted
        expr: db_pool_available_connections{service="agent-api"} < 5
        for: 2m
        labels:
          severity: critical
          service: agent-api
        annotations:
          summary: "数据库连接池即将耗尽"
          description: "可用连接数不足 5 个 (当前值: {{ $value }})"

      # 数据库查询时间过长
      - alert: DatabaseSlowQueries
        expr: histogram_quantile(0.99, sum(rate(db_query_duration_seconds_bucket{service="agent-api"}[5m])) by (le, operation)) > 1
        for: 5m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "数据库查询时间过长"
          description: "数据库操作 {{ $labels.operation }} 的 P99 查询时间超过 1s"

  - name: one-data-studio-vector
    rules:
      # 向量检索延迟过高
      - alert: VectorSearchHighLatency
        expr: histogram_quantile(0.95, sum(rate(vector_search_duration_seconds_bucket{service="agent-api"}[5m])) by (le, collection)) > 0.1
        for: 5m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "向量检索延迟过高"
          description: "向量集合 {{ $labels.collection }} 的 P95 检索延迟超过 100ms"

      # 向量存储容量告警
      - alert: VectorStorageCapacity
        expr: milvus_collection_rows_count{} > 10000000
        for: 1m
        labels:
          severity: warning
          service: milvus
        annotations:
          summary: "向量存储容量接近上限"
          description: "Milvus 集合行数超过 1000 万条"

  - name: one-data-studio-llm
    rules:
      # LLM API 调用失败率
      - alert: LLMCallFailureRate
        expr: sum(rate(llm_calls_total{status="error"}[5m])) / sum(rate(llm_calls_total[5m])) > 0.1
        for: 5m
        labels:
          severity: critical
          service: agent-api
        annotations:
          summary: "LLM API 调用失败率过高"
          description: "LLM 调用失败率超过 10%"

      # LLM Token 使用量过高
      - alert: LLMHighTokenUsage
        expr: sum(rate(llm_tokens_total[1h])) > 100000
        for: 1h
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "LLM Token 使用量过高"
          description: "过去 1 小时 Token 使用量超过 10 万"

  - name: one-data-studio-workflow
    rules:
      # 工作流执行失败率
      - alert: WorkflowExecutionFailureRate
        expr: sum(rate(workflow_executions_total{status="failed"}[1h])) / sum(rate(workflow_executions_total[1h])) > 0.1
        for: 30m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "工作流执行失败率过高"
          description: "工作流执行失败率超过 10%"

      # 工作流执行时间过长
      - alert: WorkflowExecutionTimeout
        expr: histogram_quantile(0.95, sum(rate(workflow_execution_duration_seconds_bucket[5m])) by (le, workflow_id)) > 300
        for: 10m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "工作流执行时间过长"
          description: "工作流 {{ $labels.workflow_id }} 的 P95 执行时间超过 5 分钟"

      # 待处理工作流积压
      - alert: WorkflowQueueBacklog
        expr: sum(workflow_pending_count) > 100
        for: 15m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "待处理工作流积压"
          description: "待处理工作流数量超过 100 个"

  - name: one-data-studio-agent
    rules:
      # Agent 执行成功率
      - alert: AgentLowSuccessRate
        expr: sum(rate(agent_executions_total{status="success"}[1h])) / sum(rate(agent_executions_total[1h])) < 0.8
        for: 30m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "Agent 执行成功率过低"
          description: "Agent 执行成功率低于 80%"

      # Agent 迭代次数过多
      - alert: AgentHighIterations
        expr: histogram_quantile(0.9, sum(rate(agent_iterations_bucket[5m])) by (le)) > 8
        for: 10m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "Agent 迭代次数过多"
          description: "90% 的 Agent 执行迭代次数超过 8 次"

  - name: one-data-studio-rag
    rules:
      # RAG 检索质量
      - alert: RAGLowRelevanceScore
        expr: avg(rag_relevance_score) < 0.7
        for: 30m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "RAG 检索相关性评分过低"
          description: "RAG 检索平均相关性评分低于 0.7"

      # RAG 空结果率
      - alert: RAGHighEmptyResultRate
        expr: sum(rate(rag_queries_total{result="empty"}[1h])) / sum(rate(rag_queries_total[1h])) > 0.2
        for: 30m
        labels:
          severity: warning
          service: agent-api
        annotations:
          summary: "RAG 查询空结果率过高"
          description: "RAG 查询无结果的比例超过 20%"

  - name: one-data-studio-infrastructure
    rules:
      # 服务实例健康
      - alert: ServiceInstanceUnhealthy
        expr: up{job=~"agent-api|data-api|openai-proxy"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "服务实例不健康"
          description: "服务 {{ $labels.job }} 实例 {{ $labels.instance }} 不可用"

      # CPU 使用率过高
      - alert: HighCPUUsage
        expr: sum(rate(container_cpu_usage_seconds_total{namespace="one-data-studio"}[5m])) by (pod) / sum(kube_pod_container_resource_limits{resource="cpu", namespace="one-data-studio"}) by (pod) > 0.9
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPU 使用率过高"
          description: "Pod {{ $labels.pod }} CPU 使用率超过 90%"

      # 内存使用率过高
      - alert: HighMemoryUsage
        expr: sum(container_memory_usage_bytes{namespace="one-data-studio"}) by (pod) / sum(kube_pod_container_resource_limits{resource="memory", namespace="one-data-studio"}) by (pod) > 0.9
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "内存使用率过高"
          description: "Pod {{ $labels.pod }} 内存使用率超过 90%"

      # 磁盘空间不足
      - alert: LowDiskSpace
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "磁盘空间不足"
          description: "节点 {{ $labels.instance }} 磁盘可用空间低于 10%"

  - name: one-data-studio-tenant
    rules:
      # 租户配额即将耗尽
      - alert: TenantQuotaNearLimit
        expr: tenant_resource_usage / tenant_resource_quota > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "租户配额即将耗尽"
          description: "租户 {{ $labels.tenant_id }} 的 {{ $labels.resource }} 使用率超过 90%"

      # 租户 API 调用限流
      - alert: TenantRateLimited
        expr: sum(rate(tenant_rate_limit_hits_total[5m])) by (tenant_id) > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "租户触发限流"
          description: "租户 {{ $labels.tenant_id }} 过去 5 分钟被限流超过 100 次"
