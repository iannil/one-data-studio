# AlertManager 告警管理配置
# Sprint 3.2: 告警聚合和通知

---
# Alertmanager SMTP Credentials Secret
# 警告：这是占位符配置，生产环境必须通过 External Secrets 或 Sealed Secrets 管理
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-smtp-credentials
  namespace: one-data-system
  annotations:
    one-data.io/placeholder: "true"
    one-data.io/description: "生产环境请替换为真实 SMTP 凭据"
type: Opaque
stringData:
  smtp-username: "CHANGE_ME_SMTP_USERNAME"
  smtp-password: "CHANGE_ME_SMTP_PASSWORD"

---
# AlertManager ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: one-data-system
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      # SMTP 配置（用于邮件通知）
      # 凭据通过环境变量注入，见 Deployment 配置
      smtp_smarthost: 'smtp.example.com:587'
      smtp_from: 'alertmanager@one-data.local'
      # smtp_auth_username 和 smtp_auth_password 由 Secret 提供

    # 告警路由配置
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'default'

      # 子路由配置
      routes:
        # Critical 级别告警 - 立即发送
        - match:
            severity: critical
          receiver: 'critical'
          group_wait: 10s
          repeat_interval: 5m

        # API 服务告警
        - match:
            component: api
          receiver: 'api-team'

        # 数据库告警
        - match:
            component: database
          receiver: 'dba-team'

        # 存储告警
        - match:
            component: storage
          receiver: 'ops-team'

    # 接收器配置
    receivers:
      # 默认接收器
      - name: 'default'
        email_configs:
        - to: 'alerts@one-data.local'
          headers:
            Subject: '[Alert] {{ .GroupLabels.alertname }}'

      # Critical 告警接收器
      - name: 'critical'
        email_configs:
        - to: 'oncall@one-data.local'
          headers:
            Subject: '[CRITICAL] {{ .GroupLabels.alertname }}'
        webhook_configs:
        - url: 'http://webhook-service:8080/alerts'
          send_resolved: true

      # API 团队接收器
      - name: 'api-team'
        email_configs:
        - to: 'api-team@one-data.local'
          headers:
            Subject: '[API Alert] {{ .GroupLabels.alertname }}'

      # DBA 团队接收器
      - name: 'dba-team'
        email_configs:
        - to: 'dba-team@one-data.local'
          headers:
            Subject: '[DB Alert] {{ .GroupLabels.alertname }}'

      # 运维团队接收器
      - name: 'ops-team'
        email_configs:
        - to: 'ops-team@one-data.local'
          headers:
            Subject: '[Ops Alert] {{ .GroupLabels.alertname }}'

    # 抑制规则
    inhibit_rules:
      # 如果有 critical 级别的告警，抑制同服务的 warning 告警
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'instance']

---
# AlertManager Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: one-data-system
  labels:
    app: alertmanager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      labels:
        app: alertmanager
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9093"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534  # nobody user
        fsGroup: 65534
      containers:
      - name: alertmanager
        image: prom/alertmanager:v0.26.0
        args:
        - '--config.file=/etc/alertmanager/alertmanager.yml'
        - '--storage.path=/alertmanager'
        - '--web.external-url=http://alertmanager.one-data.local'
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
          readOnlyRootFilesystem: true
        env:
        - name: SMTP_AUTH_USERNAME
          valueFrom:
            secretKeyRef:
              name: alertmanager-smtp-credentials
              key: smtp-username
        - name: SMTP_AUTH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: alertmanager-smtp-credentials
              key: smtp-password
        ports:
        - name: web
          containerPort: 9093
        - name: mesh
          containerPort: 9094
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9093
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9093
          initialDelaySeconds: 30
          periodSeconds: 10
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: config
          mountPath: /etc/alertmanager
        - name: data
          mountPath: /alertmanager
      volumes:
      - name: config
        configMap:
          name: alertmanager-config
      - name: data
        emptyDir: {}

---
# AlertManager Service
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: one-data-system
  labels:
    app: alertmanager
spec:
  type: ClusterIP
  selector:
    app: alertmanager
  ports:
  - name: web
    port: 9093
    targetPort: 9093
  - name: mesh
    port: 9094
    targetPort: 9094

---
# AlertManager Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: alertmanager-ingress
  namespace: one-data-system
spec:
  ingressClassName: nginx
  rules:
  - host: alertmanager.one-data.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: alertmanager
            port:
              number: 9093
