# ONE-DATA-STUDIO Jaeger Deployment Configuration
# Sprint 11.2: 分布式追踪 - Jaeger 配置

---
# Jaeger Operator (可选：使用 Operator 部署)
apiVersion: v1
kind: Namespace
metadata:
  name: observability
  labels:
    istio-injection: enabled

---
# Jaeger All-in-One Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
  namespace: observability
  labels:
    app: jaeger
    app.kubernetes.io/name: jaeger
    app.kubernetes.io/component: all-in-one
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
        app.kubernetes.io/name: jaeger
        app.kubernetes.io/component: all-in-one
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:1.52
        imagePullPolicy: IfNotPresent
        env:
        - name: COLLECTOR_OTLP_ENABLED
          value: "true"
        - name: SPAN_STORAGE_TYPE
          value: elasticsearch
        - name: ES_SERVER_URLS
          value: "http://elasticsearch:9200"
        - name: ES_VERSION
          value: "7"
        # 使用内存存储用于开发环境
        # - name: SPAN_STORAGE_TYPE
        #   value: memory
        ports:
        - name: ui-port
          containerPort: 16686
          protocol: TCP
        - name: grpc
          containerPort: 14250
          protocol: TCP
        - name: c-tspan-trft
          containerPort: 14267
          protocol: TCP
        - name: c-compact
          containerPort: 14268
          protocol: TCP
        - name: otlp-grpc
          containerPort: 4317
          protocol: TCP
        - name: otlp-http
          containerPort: 4318
          protocol: TCP
        - name: zipkin
          containerPort: 9411
          protocol: TCP
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /
            port: 14269
          initialDelaySeconds: 5
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /
            port: 14269
          initialDelaySeconds: 5
          periodSeconds: 15

---
# Jaeger Service
apiVersion: v1
kind: Service
metadata:
  name: jaeger
  namespace: observability
  labels:
    app: jaeger
spec:
  type: ClusterIP
  ports:
  - name: ui
    port: 16686
    targetPort: ui-port
    protocol: TCP
  - name: grpc
    port: 14250
    targetPort: grpc
    protocol: TCP
  - name: c-tspan-trft
    port: 14267
    targetPort: c-tspan-trft
    protocol: TCP
  - name: c-compact
    port: 14268
    targetPort: c-compact
    protocol: TCP
  - name: otlp-grpc
    port: 4317
    targetPort: otlp-grpc
    protocol: TCP
  - name: otlp-http
    port: 4318
    targetPort: otlp-http
    protocol: TCP
  - name: zipkin
    port: 9411
    targetPort: zipkin
    protocol: TCP
  selector:
    app: jaeger

---
# Jaeger UI Ingress (用于外部访问)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jaeger-ingress
  namespace: observability
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
  - host: jaeger.one-data.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: jaeger
            port:
              number: 16686

---
# Jaeger Istio Gateway (使用 Istio Gateway)
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: jaeger-gateway
  namespace: observability
spec:
  selector:
    istio: ingressgateway
  servers:
  - name: http
    port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "jaeger.one-data.local"

---
# Jaeger VirtualService
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: jaeger-vs
  namespace: observability
spec:
  hosts:
  - "jaeger.one-data.local"
  gateways:
  - jaeger-gateway
  http:
  - route:
    - destination:
        host: jaeger
        port:
          number: 16686

---
# OpenTelemetry Collector Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opentelemetry-collector
  namespace: observability
  labels:
    app: opentelemetry-collector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: opentelemetry-collector
  template:
    metadata:
      labels:
        app: opentelemetry-collector
    spec:
      containers:
      - name: otel-collector
        image: otel/opentelemetry-collector-contrib:0.96.0
        args:
        - --config=/etc/otelcol-contrib/config.yaml
        ports:
        - name: otlp-grpc
          containerPort: 4317
        - name: otlp-http
          containerPort: 4318
        - name: metrics
          containerPort: 8888
        volumeMounts:
        - name: config
          mountPath: /etc/otelcol-contrib
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
      volumes:
      - name: config
        configMap:
          name: otel-collector-config

---
# OpenTelemetry Collector ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: observability
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      # 接收 Istio 代理的遥测数据
      zipkin:
        endpoint: 0.0.0.0:9411

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
      # 添加资源属性
      resource:
        attributes:
          - key: environment
            value: production
            action: upsert
      # 内存限制
      memory_limiter:
        check_interval: 1s
        limit_mib: 512
        spike_limit_mib: 128

    exporters:
      # 导出到 Jaeger
      otlp:
        endpoint: jaeger:4317
        tls:
          insecure: true
      # 导出到 Prometheus（用于指标）
      prometheusremotewrite:
        endpoint: http://prometheus:9090/api/v1/write
        tls:
          insecure: true

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      pprof:
        endpoint: localhost:1777

    service:
      extensions:
      - health_check
      - pprof
      pipelines:
        traces:
          receivers:
          - otlp
          - zipkin
          processors:
          - memory_limiter
          - batch
          - resource
          exporters:
          - otlp
        metrics:
          receivers:
          - otlp
          processors:
          - batch
          exporters:
          - prometheusremotewrite

---
# OpenTelemetry Collector Service
apiVersion: v1
kind: Service
metadata:
  name: opentelemetry-collector
  namespace: observability
  labels:
    app: opentelemetry-collector
spec:
  type: ClusterIP
  ports:
  - name: otlp-grpc
    port: 4317
    targetPort: 4317
    protocol: TCP
  - name: otlp-http
    port: 4318
    targetPort: 4318
    protocol: TCP
  - name: metrics
    port: 8888
    targetPort: 8888
    protocol: TCP
  selector:
    app: opentelemetry-collector

---
# Elasticsearch (用于 Jaeger 存储)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: elasticsearch
  namespace: observability
spec:
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: docker.elastic.co/elasticsearch/elasticsearch:7.17.15
        env:
        - name: discovery.type
          value: single-node
        - name: ES_JAVA_OPTS
          value: "-Xms512m -Xmx512m"
        - name: xpack.security.enabled
          value: "false"
        ports:
        - name: http
          containerPort: 9200
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi

---
# Elasticsearch Service
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch
  namespace: observability
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 9200
    targetPort: 9200
  selector:
    app: elasticsearch

---
# ServiceMonitor for Jaeger (Prometheus 监控)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: jaeger
  namespace: observability
  labels:
    app: jaeger
spec:
  selector:
    matchLabels:
      app: jaeger
  endpoints:
  - port: c-compact
    interval: 30s
    path: /metrics
