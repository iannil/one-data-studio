# Allow Ingress NetworkPolicy
# Sprint 24: Security Hardening
# Allow traffic from ingress controller to frontend and API services

---
# Allow ingress to web-frontend from nginx ingress controller
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-web
  namespace: one-data-web
spec:
  podSelector:
    matchLabels:
      app: web-frontend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080

---
# Allow ingress to data-api from nginx ingress controller
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-data
  namespace: one-data-data
spec:
  podSelector:
    matchLabels:
      app: data-api
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080

---
# Allow ingress to agent-api from nginx ingress controller and other services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-agent
  namespace: one-data-agent
spec:
  podSelector:
    matchLabels:
      app: agent-api
  policyTypes:
  - Ingress
  ingress:
  # From ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  # From web-frontend
  - from:
    - namespaceSelector:
        matchLabels:
          app: one-data-studio
          component: web-frontend
    ports:
    - protocol: TCP
      port: 8080

---
# Allow ingress to openai-proxy from agent-api
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-openai-proxy
  namespace: one-data-model
spec:
  podSelector:
    matchLabels:
      app: openai-proxy
  policyTypes:
  - Ingress
  ingress:
  # From agent-api namespace
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: one-data-agent
    ports:
    - protocol: TCP
      port: 8000
  # From ingress controller (optional, for direct API access)
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8000
