# ONE-DATA-STUDIO Circuit Breaker Configuration
# Sprint 11.1: 服务网格与流量管理 - 熔断器实现

---
# Circuit Breaker: Data API
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: data-api-circuit-breaker
  namespace: one-data-data
spec:
  host: data-api
  trafficPolicy:
    # 连接池熔断配置
    connectionPool:
      tcp:
        maxConnections: 50  # 最大连接数，超过则熔断
        connectTimeout: 5s
        tcpKeepAlive:
          time: 300s
          interval: 75s
      http:
        http1MaxPendingRequests: 50  # 最大等待请求数
        http2MaxRequests: 100  # HTTP/2 最大并发请求数
        maxRequestsPerConnection: 5  # 每个连接最大请求数
        maxRetries: 3
        idleTimeout: 60s
        h2UpgradePolicy: UPGRADE
    # 异常检测熔断配置
    outlierDetection:
      consecutiveGatewayErrors: 5  # 连续网关错误数
      consecutive5xxErrors: 5  # 连续 5xx 错误数
      interval: 30s  # 检测间隔
      baseEjectionTime: 60s  # 熔断持续时间
      maxEjectionPercent: 50  # 最大熔断实例百分比
      minHealthPercent: 40  # 最小健康实例百分比
      # 成功率检测
      successRateMinimumHosts: 3  # 至少 3 个实例才计算成功率
      successRateRequestVolume: 20  # 最小请求数
      successRateStdevFactor: 1900  # 成功率标准差因子
    # 熔断后的降级策略
    fallback:
      host: data-api-fallback  # 降级服务
      port:
        number: 8080

---
# Circuit Breaker: Agent API
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: agent-api-circuit-breaker
  namespace: one-data-agent
spec:
  host: agent-api
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 80
        connectTimeout: 5s
      http:
        http1MaxPendingRequests: 80
        http2MaxRequests: 200
        maxRequestsPerConnection: 10
        maxRetries: 2
        idleTimeout: 120s
        h2UpgradePolicy: UPGRADE
        # 检测请求超时
        detectTimeoutOnRead: true
        detectTimeoutOnWrite: true
    outlierDetection:
      consecutiveGatewayErrors: 3  # LLM 服务更敏感
      consecutive5xxErrors: 3
      interval: 20s
      baseEjectionTime: 90s  # 更长的熔断时间
      maxEjectionPercent: 60
      minHealthPercent: 30
      successRateMinimumHosts: 2
      successRateRequestVolume: 10
      successRateStdevFactor: 1900

---
# Circuit Breaker: OpenAI Proxy (模型服务)
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: openai-proxy-circuit-breaker
  namespace: one-data-model
spec:
  host: openai-proxy
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 3s
      http:
        http1MaxPendingRequests: 200  # 模型服务需要更高的并发
        http2MaxRequests: 500
        maxRequestsPerConnection: 3
        maxRetries: 2
        idleTimeout: 300s
        h2UpgradePolicy: UPGRADE
        # 请求超时检测
        detectTimeoutOnRead: true
        detectTimeoutOnWrite: true
    outlierDetection:
      consecutiveGatewayErrors: 2  # 模型服务最敏感
      consecutive5xxErrors: 2
      interval: 15s  # 更频繁的检测
      baseEjectionTime: 120s  # 更长的熔断恢复时间
      maxEjectionPercent: 70
      minHealthPercent: 20  # 允许更低的健康实例数
      successRateMinimumHosts: 2
      successRateRequestVolume: 5  # 更少的请求就触发检测
      successRateStdevFactor: 1900

---
# Circuit Breaker: Web Frontend
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: web-frontend-circuit-breaker
  namespace: one-data-system
spec:
  host: web-frontend
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 40
        connectTimeout: 5s
      http:
        http1MaxPendingRequests: 40
        http2MaxRequests: 100
        maxRequestsPerConnection: 5
        maxRetries: 2
        idleTimeout: 60s
        h2UpgradePolicy: DO_NOT_DOWNGRADE
    outlierDetection:
      consecutiveGatewayErrors: 10
      consecutive5xxErrors: 10
      interval: 60s
      baseEjectionTime: 30s
      maxEjectionPercent: 40
      minHealthPercent: 50

---
# Service Entry: 外部服务熔断配置
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: external-openai-circuit-breaker
  namespace: one-data-system
spec:
  host: api.openai.com
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 30  # 外部服务限制连接数
        connectTimeout: 10s
      http:
        http1MaxPendingRequests: 30
        http2MaxRequests: 50
        maxRequestsPerConnection: 2
        maxRetries: 2
        idleTimeout: 300s
    outlierDetection:
      consecutiveGatewayErrors: 3
      consecutive5xxErrors: 3
      interval: 30s
      baseEjectionTime: 60s
      maxEjectionPercent: 100  # 全部熔断
      minHealthPercent: 0

---
# Fault Injection: 测试熔断器
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: fault-injection-test
  namespace: one-data-system
spec:
  hosts:
  - "api.one-data.local"
  gateways:
  - one-data-system/api-gateway
  http:
  - match:
    - headers:
        x-fault-injection:
          exact: "true"
    fault:
      delay:
        percentage:
          value: 100
        fixedDelay: 5s  # 注入 5 秒延迟
      abort:
        percentage:
          value: 50
        httpStatus: 503  # 50% 返回 503 错误
    route:
    - destination:
        host: agent-api

---
# Retry Policy: 智能重试配置
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: retry-policy
  namespace: one-data-system
spec:
  hosts:
  - "api.one-data.local"
  gateways:
  - one-data-system/api-gateway
  http:
  - match:
    - uri:
        prefix: /api/v1/datasets
    route:
    - destination:
        host: data-api
      weight: 100
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,connect-failure,refused-stream,reset,gateway-error,stream-error
      retryRemoteLocalities: true

---
# Rate Limit based Service Protection
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: rate-limit-service-protection
  namespace: one-data-system
spec:
  hosts:
  - "api.one-data.local"
  gateways:
  - one-data-system/api-gateway
  http:
  - match:
    - uri:
        prefix: /api/v1/
    route:
    - destination:
        host: agent-api
    # 与 RateLimitService 集成
    headers:
      request:
        add:
          x-limited: "true"
