# Redis Sentinel HA 配置
# Sprint 14: 高可用基础设施 - Redis Sentinel 模式

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-ha-config
  namespace: one-data-infra
  labels:
    app: redis-ha
data:
  # Redis Master 配置
  redis.conf: |
    bind 0.0.0.0
    port 6379
    protected-mode yes
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300

    daemonize no
    supervised no
    pidfile /var/run/redis/redis.pid
    loglevel notice
    logfile ""

    databases 16

    # 持久化配置
    save 900 1
    save 300 10
    save 60 10000
    stop-writes-on-bgsave-error yes
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data

    # 认证
    requirepass ${REDIS_PASSWORD}
    masterauth ${REDIS_PASSWORD}

    # 内存管理
    maxmemory 2gb
    maxmemory-policy allkeys-lru

    # AOF 持久化
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb

    # 复制配置
    replica-serve-stale-data yes
    replica-read-only yes
    repl-diskless-sync no
    repl-diskless-sync-delay 5
    repl-ping-replica-period 10
    repl-timeout 60
    repl-disable-tcp-nodelay no
    repl-backlog-size 1mb
    repl-backlog-ttl 3600

    # 集群/Sentinel
    replica-priority 100
    min-replicas-to-write 0
    min-replicas-max-lag 10

  # Sentinel 配置
  sentinel.conf: |
    port 26379
    dir /data

    # 监控 Master
    sentinel monitor mymaster redis-master 6379 2
    sentinel auth-pass mymaster ${REDIS_PASSWORD}

    # 故障检测
    sentinel down-after-milliseconds mymaster 5000
    sentinel failover-timeout mymaster 60000
    sentinel parallel-syncs mymaster 1

    # Sentinel 认证
    requirepass ${SENTINEL_PASSWORD}

    # 日志
    logfile ""

  # 启动脚本
  start-redis.sh: |
    #!/bin/bash
    set -e

    # 替换环境变量
    cp /etc/redis/redis.conf /data/redis.conf
    sed -i "s/\${REDIS_PASSWORD}/${REDIS_PASSWORD}/g" /data/redis.conf

    # 如果是 replica，添加 replicaof 配置
    if [ "$REDIS_ROLE" = "replica" ]; then
      echo "replicaof redis-master 6379" >> /data/redis.conf
    fi

    exec redis-server /data/redis.conf

  start-sentinel.sh: |
    #!/bin/bash
    set -e

    # 替换环境变量
    cp /etc/redis/sentinel.conf /data/sentinel.conf
    sed -i "s/\${REDIS_PASSWORD}/${REDIS_PASSWORD}/g" /data/sentinel.conf
    sed -i "s/\${SENTINEL_PASSWORD}/${SENTINEL_PASSWORD}/g" /data/sentinel.conf

    exec redis-sentinel /data/sentinel.conf

---
apiVersion: v1
kind: Secret
metadata:
  name: redis-ha-credentials
  namespace: one-data-infra
  labels:
    app: redis-ha
type: Opaque
stringData:
  # 生产环境请使用强密码
  password: "RedisPassword123!"
  sentinel-password: "SentinelPassword123!"
