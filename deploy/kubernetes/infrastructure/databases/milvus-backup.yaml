# Milvus 备份与恢复配置
# 使用 Milvus Backup 工具实现数据备份

---
# Milvus Backup ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: milvus-backup-config
  namespace: one-data-infra
  labels:
    app: milvus-backup
data:
  # Milvus 连接配置
  MILVUS_ADDRESS: "milvus.one-data-infra.svc.cluster.local:19530"
  MILVUS_BACKUP_ADDRESS: "milvus-backup.one-data-infra.svc.cluster.local:8080"

  # MinIO 备份存储
  MINIO_ADDRESS: "minio.one-data-infra.svc.cluster.local:9000"
  MINIO_BUCKET: "milvus-backup"
  MINIO_BACKUP_PATH: "/milvus-backup"

  # 备份配置
  BACKUP_RETENTION_DAYS: "30"  # 保留 30 天
  BACKUP_SCHEDULE: "0 3 * * *"  # 每天凌晨 3 点执行

  # 日志级别
  LOG_LEVEL: "INFO"

---
# Milvus Backup Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: milvus-backup
  namespace: one-data-infra
  labels:
    app: milvus-backup
spec:
  replicas: 1
  selector:
    matchLabels:
      app: milvus-backup
  template:
    metadata:
      labels:
        app: milvus-backup
    spec:
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      initContainers:
      # 创建备份存储桶
      - name: init-bucket
        image: minio/mc:latest
        command:
        - /bin/sh
        - -c
        - |
          mc alias set minio http://minio.one-data-infra.svc.cluster.local:9000 \
            ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY}
          mc mb minio/milvus-backup --ignore-existing
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
      containers:
      - name: backup
        image: milvusdb/milvus-backup:v0.4.0
        command:
        - /milvus-backup
        - server
        - --port
        - "8080"
        env:
        - name: MILVUS_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-backup-config
              key: MILVUS_ADDRESS
        - name: MINIO_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-backup-config
              key: MINIO_ADDRESS
        - name: MINIO_BUCKET
          valueFrom:
            configMapKeyRef:
              name: milvus-backup-config
              key: MINIO_BUCKET
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
        ports:
        - containerPort: 8080
          name: http
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5

---
# Milvus Backup Service
apiVersion: v1
kind: Service
metadata:
  name: milvus-backup
  namespace: one-data-infra
  labels:
    app: milvus-backup
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  selector:
    app: milvus-backup

---
# Milvus 定时备份 CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: milvus-daily-backup
  namespace: one-data-infra
  labels:
    app: milvus-backup
spec:
  schedule: "0 3 * * *"  # 每天凌晨 3 点
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 小时超时
      template:
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            fsGroup: 1000
          containers:
          - name: backup
            image: curlimages/curl:latest
            command:
            - sh
            - -c
            - |
              # 生成备份名称
              BACKUP_NAME="milvus-backup-$(date +%Y%m%d-%H%M%S)"

              echo "Creating backup: ${BACKUP_NAME}"

              # 创建备份
              curl -X POST "http://milvus-backup:8080/api/v1/backup/create" \
                -H "Content-Type: application/json" \
                -d "{\"backup_name\": \"${BACKUP_NAME}\", \"collection_names\": []}"

              echo "Waiting for backup to complete..."
              sleep 60

              # 获取备份状态
              curl -X GET "http://milvus-backup:8080/api/v1/backup/get?backup_name=${BACKUP_NAME}"

              echo "Backup ${BACKUP_NAME} created successfully"

              # 清理旧备份 (保留 30 天)
              OLD_BACKUPS=$(curl -s "http://milvus-backup:8080/api/v1/backup/list" | \
                jq -r '.data[] | select(.created_at < now - 30*24*3600) | .name')

              for OLD_BACKUP in $OLD_BACKUPS; do
                echo "Deleting old backup: ${OLD_BACKUP}"
                curl -X DELETE "http://milvus-backup:8080/api/v1/backup/delete?backup_name=${OLD_BACKUP}"
              done
            resources:
              requests:
                memory: "128Mi"
                cpu: "50m"
              limits:
                memory: "256Mi"
                cpu: "200m"

---
# Milvus 恢复 Job (模板，手动触发)
apiVersion: batch/v1
kind: Job
metadata:
  name: milvus-restore-example
  namespace: one-data-infra
  labels:
    app: milvus-backup
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      containers:
      - name: restore
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          BACKUP_NAME="${BACKUP_NAME:-milvus-backup-latest}"

          echo "Restoring from backup: ${BACKUP_NAME}"

          # 获取备份列表
          curl -X GET "http://milvus-backup:8080/api/v1/backup/list"

          # 执行恢复
          curl -X POST "http://milvus-backup:8080/api/v1/backup/restore" \
            -H "Content-Type: application/json" \
            -d "{\"backup_name\": \"${BACKUP_NAME}\", \
                  \"collection_names\": [], \
                  \"drop_collection_before_restore\": false}"

          echo "Restore initiated. Please check Milvus logs for progress."
        env:
        - name: BACKUP_NAME
          value: ""  # 通过 --set 传入具体备份名称
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"

---
# Milvus 备份 RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: milvus-backup
  namespace: one-data-infra

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: milvus-backup
  namespace: one-data-infra
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: milvus-backup
  namespace: one-data-infra
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: milvus-backup
subjects:
- kind: ServiceAccount
  name: milvus-backup
  namespace: one-data-infra

---
# Milvus 备份 VolumeSnapshotClass (需要 CSI 驱动支持)
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: milvus-snapshot
  annotations:
    snapshot.storage.kubernetes.io/is-default-class: "true"
driver:csi.storage.hci.example.com  # 根据实际 CSI 驱动修改
deletionPolicy: Delete
parameters:
  type: fast
