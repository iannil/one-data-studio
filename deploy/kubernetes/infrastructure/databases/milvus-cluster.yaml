# Milvus 高可用集群配置
# 向量数据库用于 RAG 和语义搜索

---
# Milvus ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: milvus-config
  namespace: one-data-infra
  labels:
    app: milvus
data:
  # Milvus 依赖配置
  ETCD_ENDPOINTS: "etcd.one-data-infra.svc.cluster.local:2379"
  MINIO_ADDRESS: "minio.one-data-infra.svc.cluster.local:9000"
  PULSAR_ADDRESS: "pulsar.one-data-infra.svc.cluster.local:6650"

  # 存储配置
  MINIO_BUCKET: "milvus"
  MINIO_USE_SSL: "false"
  MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY}"
  MINIO_SECRET_KEY: "${MINIO_SECRET_KEY}"

  # 内存配置
  QUERY_NODE_MAX_MEMORY: "8589934592"  # 8GB
  QUERY_NODE_MEMORY_POOL_SIZE: "8589934592"

  # 索引构建配置
  INDEX_NODE_MAX_BUILD_TASKS: "16"
  INDEX_NODE_WAIT_INDEX_FINISH_INTERVAL: "5"

  # 查询配置
  QUERY_NODE_MAX_TASK: "32"

  # 缓存配置
  CACHE_SIZE: "4GB"

  # 日志配置
  LOG_LEVEL: "INFO"

---
# Milvus RootCoord Service
# 根协调器 - 负责处理数据定义语言 (DDL) 和数据控制语言 (DCL)
apiVersion: v1
kind: Service
metadata:
  name: milvus-rootcoord
  namespace: one-data-infra
  labels:
    component: rootcoord
    app: milvus
spec:
  clusterIP: None
  ports:
    - name: grpc
      port: 19531
      targetPort: 19531
  selector:
    component: rootcoord
    app: milvus

---
# Milvus DataCoord Service
# 数据协调器 - 负责数据操作的元数据管理和时间戳分配
apiVersion: v1
kind: Service
metadata:
  name: milvus-datacoord
  namespace: one-data-infra
  labels:
    component: datacoord
    app: milvus
spec:
  clusterIP: None
  ports:
    - name: grpc
      port: 13333
      targetPort: 13333
  selector:
    component: datacoord
    app: milvus

---
# Milvus QueryCoord Service
# 查询协调器 - 负责拓扑管理和负载均衡
apiVersion: v1
kind: Service
metadata:
  name: milvus-querycoord
  namespace: one-data-infra
  labels:
    component: querycoord
    app: milvus
spec:
  clusterIP: None
  ports:
    - name: grpc
      port: 19531
      targetPort: 19531
  selector:
    component: querycoord
    app: milvus

---
# Milvus IndexCoord Service
# 索引协调器 - 负责索引构建任务管理
apiVersion: v1
kind: Service
metadata:
  name: milvus-indexcoord
  namespace: one-data-infra
  labels:
    component: indexcoord
    app: milvus
spec:
  clusterIP: None
  ports:
    - name: grpc
      port: 31000
      targetPort: 31000
  selector:
    component: indexcoord
    app: milvus

---
# Milvus DataNode Service
# 数据节点 - 负责数据插入、持久化和 compaction
apiVersion: v1
kind: Service
metadata:
  name: milvus-datanode
  namespace: one-data-infra
  labels:
    component: datanode
    app: milvus
spec:
  clusterIP: None
  ports:
    - name: grpc
      port: 9091
      targetPort: 9091
  selector:
    component: datanode
    app: milvus

---
# Milvus QueryNode Service
# 查询节点 - 负责向量搜索和查询
apiVersion: v1
kind: Service
metadata:
  name: milvus-querynode
  namespace: one-data-infra
  labels:
    component: querynode
    app: milvus
spec:
  clusterIP: None
  ports:
    - name: grpc
      port: 9091
      targetPort: 9091
  selector:
    component: querynode
    app: milvus

---
# Milvus IndexNode Service
# 索引节点 - 负责向量索引构建
apiVersion: v1
kind: Service
metadata:
  name: milvus-indexnode
  namespace: one-data-infra
  labels:
    component: indexnode
    app: milvus
spec:
  clusterIP: None
  ports:
    - name: grpc
      port: 9091
      targetPort: 9091
  selector:
    component: indexnode
    app: milvus

---
# Milvus Proxy Service
# 代理层 - 用户请求入口
apiVersion: v1
kind: Service
metadata:
  name: milvus
  namespace: one-data-infra
  labels:
    component: proxy
    app: milvus
spec:
  type: ClusterIP
  ports:
    - name: grpc
      port: 19530
      targetPort: 19530
    - name: metrics
      port: 9091
      targetPort: 9091
  selector:
    component: proxy
    app: milvus

---
# Milvus RootCoord StatefulSet (HA: 3 replicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: milvus-rootcoord
  namespace: one-data-infra
  labels:
    component: rootcoord
    app: milvus
spec:
  serviceName: milvus-rootcoord
  replicas: 3
  selector:
    matchLabels:
      component: rootcoord
      app: milvus
  template:
    metadata:
      labels:
        component: rootcoord
        app: milvus
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9091"
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    component: rootcoord
                    app: milvus
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      containers:
      - name: rootcoord
        image: milvusdb/milvus:v2.3.3
        command:
        - /milvus/bin/milvus
        - run
        - rootcoord
        args:
        - --standalone=false
        env:
        - name: ETCD_ENDPOINTS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: ETCD_ENDPOINTS
        - name: MINIO_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: MINIO_ADDRESS
        - name: PULSAR_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: PULSAR_ADDRESS
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
        ports:
        - containerPort: 19531
          name: grpc
        - containerPort: 9091
          name: metrics
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          grpc:
            port: 19531
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          grpc:
            port: 19531
          initialDelaySeconds: 10
          periodSeconds: 5

---
# Milvus DataCoord StatefulSet (HA: 3 replicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: milvus-datacoord
  namespace: one-data-infra
  labels:
    component: datacoord
    app: milvus
spec:
  serviceName: milvus-datacoord
  replicas: 3
  selector:
    matchLabels:
      component: datacoord
      app: milvus
  template:
    metadata:
      labels:
        component: datacoord
        app: milvus
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    component: datacoord
                    app: milvus
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      containers:
      - name: datacoord
        image: milvusdb/milvus:v2.3.3
        command:
        - /milvus/bin/milvus
        - run
        - datacoord
        args:
        - --standalone=false
        env:
        - name: ETCD_ENDPOINTS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: ETCD_ENDPOINTS
        - name: MINIO_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: MINIO_ADDRESS
        - name: PULSAR_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: PULSAR_ADDRESS
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
        ports:
        - containerPort: 13333
          name: grpc
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /var/lib/milvus
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 10Gi

---
# Milvus QueryCoord StatefulSet (HA: 2 replicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: milvus-querycoord
  namespace: one-data-infra
  labels:
    component: querycoord
    app: milvus
spec:
  serviceName: milvus-querycoord
  replicas: 2
  selector:
    matchLabels:
      component: querycoord
      app: milvus
  template:
    metadata:
      labels:
        component: querycoord
        app: milvus
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    component: querycoord
                    app: milvus
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      containers:
      - name: querycoord
        image: milvusdb/milvus:v2.3.3
        command:
        - /milvus/bin/milvus
        - run
        - querycoord
        args:
        - --standalone=false
        env:
        - name: ETCD_ENDPOINTS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: ETCD_ENDPOINTS
        - name: MINIO_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: MINIO_ADDRESS
        - name: PULSAR_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: PULSAR_ADDRESS
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
        ports:
        - containerPort: 19531
          name: grpc
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---
# Milvus IndexCoord StatefulSet (HA: 2 replicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: milvus-indexcoord
  namespace: one-data-infra
  labels:
    component: indexcoord
    app: milvus
spec:
  serviceName: milvus-indexcoord
  replicas: 2
  selector:
    matchLabels:
      component: indexcoord
      app: milvus
  template:
    metadata:
      labels:
        component: indexcoord
        app: milvus
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    component: indexcoord
                    app: milvus
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      containers:
      - name: indexcoord
        image: milvusdb/milvus:v2.3.3
        command:
        - /milvus/bin/milvus
        - run
        - indexcoord
        args:
        - --standalone=false
        env:
        - name: ETCD_ENDPOINTS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: ETCD_ENDPOINTS
        - name: MINIO_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: MINIO_ADDRESS
        - name: PULSAR_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: PULSAR_ADDRESS
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
        ports:
        - containerPort: 31000
          name: grpc
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---
# Milvus DataNode StatefulSet (HA: 3 replicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: milvus-datanode
  namespace: one-data-infra
  labels:
    component: datanode
    app: milvus
spec:
  serviceName: milvus-datanode
  replicas: 3
  selector:
    matchLabels:
      component: datanode
      app: milvus
  template:
    metadata:
      labels:
        component: datanode
        app: milvus
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    component: datanode
                    app: milvus
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      containers:
      - name: datanode
        image: milvusdb/milvus:v2.3.3
        command:
        - /milvus/bin/milvus
        - run
        - datanode
        args:
        - --standalone=false
        env:
        - name: ETCD_ENDPOINTS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: ETCD_ENDPOINTS
        - name: MINIO_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: MINIO_ADDRESS
        - name: PULSAR_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: PULSAR_ADDRESS
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
        ports:
        - containerPort: 9091
          name: grpc
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        volumeMounts:
        - name: data
          mountPath: /var/lib/milvus
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 50Gi

---
# Milvus QueryNode StatefulSet (HA: 3 replicas)
# 查询节点可水平扩展
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: milvus-querynode
  namespace: one-data-infra
  labels:
    component: querynode
    app: milvus
spec:
  serviceName: milvus-querynode
  replicas: 3
  selector:
    matchLabels:
      component: querynode
      app: milvus
  template:
    metadata:
      labels:
        component: querynode
        app: milvus
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    component: querynode
                    app: milvus
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      containers:
      - name: querynode
        image: milvusdb/milvus:v2.3.3
        command:
        - /milvus/bin/milvus
        - run
        - querynode
        args:
        - --standalone=false
        env:
        - name: ETCD_ENDPOINTS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: ETCD_ENDPOINTS
        - name: MINIO_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: MINIO_ADDRESS
        - name: PULSAR_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: PULSAR_ADDRESS
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
        - name: QUERY_NODE_MAX_MEMORY
          value: "8589934592"  # 8GB
        ports:
        - containerPort: 9091
          name: grpc
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "8Gi"
            cpu: "4000m"
        volumeMounts:
        - name: data
          mountPath: /var/lib/milvus
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 20Gi

---
# Milvus IndexNode StatefulSet (HA: 2 replicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: milvus-indexnode
  namespace: one-data-infra
  labels:
    component: indexnode
    app: milvus
spec:
  serviceName: milvus-indexnode
  replicas: 2
  selector:
    matchLabels:
      component: indexnode
      app: milvus
  template:
    metadata:
      labels:
        component: indexnode
        app: milvus
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    component: indexnode
                    app: milvus
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      containers:
      - name: indexnode
        image: milvusdb/milvus:v2.3.3
        command:
        - /milvus/bin/milvus
        - run
        - indexnode
        args:
        - --standalone=false
        env:
        - name: ETCD_ENDPOINTS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: ETCD_ENDPOINTS
        - name: MINIO_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: MINIO_ADDRESS
        - name: PULSAR_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: PULSAR_ADDRESS
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
        - name: INDEX_NODE_MAX_BUILD_TASKS
          value: "16"
        ports:
        - containerPort: 9091
          name: grpc
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        volumeMounts:
        - name: data
          mountPath: /var/lib/milvus
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 30Gi

---
# Milvus Proxy Deployment (HA: 3 replicas)
# 代理层无状态，使用 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: milvus-proxy
  namespace: one-data-infra
  labels:
    component: proxy
    app: milvus
spec:
  replicas: 3
  selector:
    matchLabels:
      component: proxy
      app: milvus
  template:
    metadata:
      labels:
        component: proxy
        app: milvus
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    component: proxy
                    app: milvus
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      containers:
      - name: proxy
        image: milvusdb/milvus:v2.3.3
        command:
        - /milvus/bin/milvus
        - run
        - proxy
        args:
        - --standalone=false
        env:
        - name: ETCD_ENDPOINTS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: ETCD_ENDPOINTS
        - name: PULSAR_ADDRESS
          valueFrom:
            configMapKeyRef:
              name: milvus-config
              key: PULSAR_ADDRESS
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access_key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret_key
        ports:
        - containerPort: 19530
          name: grpc
        - containerPort: 9091
          name: metrics
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 9091
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /healthz
            port: 9091
          initialDelaySeconds: 10
          periodSeconds: 5

---
# Milvus PodDisruptionBudget (高可用保障)
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: milvus-proxy-pdb
  namespace: one-data-infra
spec:
  minAvailable: 1
  selector:
    matchLabels:
      component: proxy
      app: milvus

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: milvus-querynode-pdb
  namespace: one-data-infra
spec:
  minAvailable: 2
  selector:
    matchLabels:
      component: querynode
      app: milvus

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: milvus-datanode-pdb
  namespace: one-data-infra
spec:
  minAvailable: 2
  selector:
    matchLabels:
      component: datanode
      app: milvus
