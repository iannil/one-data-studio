# MySQL HA 配置
# Sprint 14: 高可用基础设施 - MySQL 主从复制配置

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-ha-config
  namespace: one-data-infra
  labels:
    app: mysql-ha
data:
  # Primary (Master) 配置
  primary.cnf: |
    [mysqld]
    server-id=1
    log-bin=mysql-bin
    binlog-format=ROW
    binlog-row-image=FULL
    sync_binlog=1
    innodb_flush_log_at_trx_commit=1
    gtid_mode=ON
    enforce_gtid_consistency=ON
    log-slave-updates=ON

    # 性能配置
    default_authentication_plugin=mysql_native_password
    max_connections=500
    innodb_buffer_pool_size=2G
    innodb_log_file_size=256M
    innodb_log_buffer_size=64M

    # 复制相关
    relay_log=mysql-relay-bin
    relay_log_purge=ON
    relay_log_recovery=ON

    # 慢查询日志
    slow_query_log=1
    slow_query_log_file=/var/log/mysql/slow.log
    long_query_time=2

    # 二进制日志过期
    binlog_expire_logs_seconds=604800

    # 并行复制
    slave_parallel_type=LOGICAL_CLOCK
    slave_parallel_workers=4
    slave_preserve_commit_order=ON

  # Replica (Slave) 配置
  replica.cnf: |
    [mysqld]
    server-id=2
    log-bin=mysql-bin
    binlog-format=ROW
    binlog-row-image=FULL
    read_only=ON
    super_read_only=ON
    gtid_mode=ON
    enforce_gtid_consistency=ON
    log-slave-updates=ON

    # 性能配置
    default_authentication_plugin=mysql_native_password
    max_connections=500
    innodb_buffer_pool_size=2G
    innodb_log_file_size=256M
    innodb_log_buffer_size=64M

    # 复制相关
    relay_log=mysql-relay-bin
    relay_log_purge=ON
    relay_log_recovery=ON

    # 慢查询日志
    slow_query_log=1
    slow_query_log_file=/var/log/mysql/slow.log
    long_query_time=2

    # 并行复制
    slave_parallel_type=LOGICAL_CLOCK
    slave_parallel_workers=4
    slave_preserve_commit_order=ON

    # 复制过滤（可选）
    # replicate-do-db=one_data

  # 初始化脚本 - 创建复制用户
  init-primary.sql: |
    -- 创建复制用户
    CREATE USER IF NOT EXISTS 'replicator'@'%' IDENTIFIED WITH mysql_native_password BY '${REPLICATION_PASSWORD}';
    GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'replicator'@'%';

    -- 创建健康检查用户
    CREATE USER IF NOT EXISTS 'healthcheck'@'localhost' IDENTIFIED WITH mysql_native_password BY 'healthcheck';
    GRANT SELECT ON *.* TO 'healthcheck'@'localhost';

    -- 创建 ProxySQL 监控用户
    CREATE USER IF NOT EXISTS 'proxysql'@'%' IDENTIFIED WITH mysql_native_password BY '${PROXYSQL_PASSWORD}';
    GRANT SELECT ON performance_schema.* TO 'proxysql'@'%';
    GRANT REPLICATION CLIENT ON *.* TO 'proxysql'@'%';

    FLUSH PRIVILEGES;

  # 初始化脚本 - Replica 连接到 Primary
  init-replica.sh: |
    #!/bin/bash
    set -e

    # 等待 Primary 准备好
    until mysql -h mysql-primary -u root -p"${MYSQL_ROOT_PASSWORD}" -e "SELECT 1" &> /dev/null; do
      echo "Waiting for primary to be ready..."
      sleep 5
    done

    echo "Primary is ready, configuring replication..."

    # 配置复制
    mysql -u root -p"${MYSQL_ROOT_PASSWORD}" <<EOF
    STOP SLAVE;
    RESET SLAVE ALL;
    CHANGE MASTER TO
      MASTER_HOST='mysql-primary',
      MASTER_USER='replicator',
      MASTER_PASSWORD='${REPLICATION_PASSWORD}',
      MASTER_AUTO_POSITION=1,
      MASTER_CONNECT_RETRY=10;
    START SLAVE;
    SHOW SLAVE STATUS\G
    EOF

    echo "Replication configured successfully!"
