# External Secrets Configuration
# Sprint 21: Security Hardening
#
# Defines how to fetch and sync secrets from external secret management systems.

---
# MySQL Database Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mysql-secrets
  namespace: one-data-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: mysql-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        MYSQL_USER: "{{ .mysql_user }}"
        MYSQL_PASSWORD: "{{ .mysql_password }}"
        MYSQL_ROOT_PASSWORD: "{{ .mysql_root_password }}"
        MYSQL_DATABASE: "{{ .mysql_database }}"
  data:
    - secretKey: mysql_user
      remoteRef:
        key: one-data-studio/mysql
        property: user
    - secretKey: mysql_password
      remoteRef:
        key: one-data-studio/mysql
        property: password
    - secretKey: mysql_root_password
      remoteRef:
        key: one-data-studio/mysql
        property: root_password
    - secretKey: mysql_database
      remoteRef:
        key: one-data-studio/mysql
        property: database

---
# Redis Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-secrets
  namespace: one-data-infra
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: redis-credentials
    creationPolicy: Owner
  data:
    - secretKey: password
      remoteRef:
        key: one-data-studio/redis
        property: password

---
# MinIO Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: minio-secrets
  namespace: one-data-infra
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: minio-credentials
    creationPolicy: Owner
  data:
    - secretKey: root-user
      remoteRef:
        key: one-data-studio/minio
        property: access_key
    - secretKey: root-password
      remoteRef:
        key: one-data-studio/minio
        property: secret_key
    - secretKey: access_key
      remoteRef:
        key: one-data-studio/minio
        property: access_key
    - secretKey: secret_key
      remoteRef:
        key: one-data-studio/minio
        property: secret_key

---
# JWT Secret Key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-secrets
  namespace: one-data-system
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: jwt-credentials
    creationPolicy: Owner
  data:
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: one-data-studio/jwt
        property: secret_key
    - secretKey: CSRF_SECRET_KEY
      remoteRef:
        key: one-data-studio/jwt
        property: csrf_secret_key

---
# OpenAI API Keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: openai-secrets
  namespace: one-data-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: openai-credentials
    creationPolicy: Owner
  data:
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: one-data-studio/openai
        property: api_key
    - secretKey: OPENAI_API_KEYS
      remoteRef:
        key: one-data-studio/openai
        property: api_keys

---
# Keycloak Admin Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: keycloak-secrets
  namespace: one-data-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: keycloak-credentials
    creationPolicy: Owner
  data:
    - secretKey: KEYCLOAK_ADMIN
      remoteRef:
        key: one-data-studio/keycloak
        property: admin_user
    - secretKey: KEYCLOAK_ADMIN_PASSWORD
      remoteRef:
        key: one-data-studio/keycloak
        property: admin_password
    - secretKey: KEYCLOAK_CLIENT_SECRET
      remoteRef:
        key: one-data-studio/keycloak
        property: client_secret

---
# Grafana Admin Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grafana-secrets
  namespace: one-data-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: grafana-credentials
    creationPolicy: Owner
  data:
    - secretKey: admin-user
      remoteRef:
        key: one-data-studio/grafana
        property: admin_user
    - secretKey: admin-password
      remoteRef:
        key: one-data-studio/grafana
        property: admin_password

---
# ProxySQL Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: proxysql-secrets
  namespace: one-data-infra
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: proxysql-mysql-credentials
    creationPolicy: Owner
  data:
    - secretKey: monitor-password
      remoteRef:
        key: one-data-studio/proxysql
        property: monitor_password
    - secretKey: onedata-password
      remoteRef:
        key: one-data-studio/proxysql
        property: onedata_password
    - secretKey: root-password
      remoteRef:
        key: one-data-studio/proxysql
        property: root_password
