# Prometheus 配置
# ONE-DATA-STUDIO Monitoring

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'one-data-studio'

# Alertmanager 配置
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'alertmanager:9093'
      # 可选：设置告警发送超时
      timeout: 10s

# 告警规则
rule_files:
  - "alerts.yml"

# 抓取配置
scrape_configs:
  # Prometheus 自身监控
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Data API 监控
  - job_name: 'data-api'
    static_configs:
      - targets: ['data-api:8001']
    metrics_path: '/metrics'
    relabel_configs:
      - source_labels: [__address__]
        target_label: service
        replacement: 'data-api'

  # Agent API 监控
  - job_name: 'agent-api'
    static_configs:
      - targets: ['agent-api:8000']
    metrics_path: '/metrics'
    relabel_configs:
      - source_labels: [__address__]
        target_label: service
        replacement: 'agent-api'

  # Model API 监控
  - job_name: 'model-api'
    static_configs:
      - targets: ['model-api:8002']
    metrics_path: '/metrics'
    relabel_configs:
      - source_labels: [__address__]
        target_label: service
        replacement: 'model-api'

  # OpenAI Proxy 监控
  - job_name: 'openai-proxy'
    static_configs:
      - targets: ['openai-proxy:8000']
    metrics_path: '/metrics'
    relabel_configs:
      - source_labels: [__address__]
        target_label: service
        replacement: 'openai-proxy'

  # ============================================
  # AI/LLM Services Monitoring
  # ============================================
  # vLLM Chat Service (LLM inference)
  - job_name: 'vllm-chat'
    static_configs:
      - targets: ['vllm-chat:8000']
    metrics_path: '/metrics'
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: service
        replacement: 'vllm-chat'

  # vLLM Embedding Service
  - job_name: 'vllm-embed'
    static_configs:
      - targets: ['vllm-embed:8000']
    metrics_path: '/metrics'
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: service
        replacement: 'vllm-embed'

  # ============================================
  # ETL Engine Monitoring
  # ============================================
  # Kettle/PDI Carte Server
  - job_name: 'kettle'
    static_configs:
      - targets: ['kettle:8080']
    metrics_path: '/metrics'
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: service
        replacement: 'kettle'

  # ============================================
  # Infrastructure Monitoring
  # ============================================
  # MySQL 监控（需要 mysqld_exporter）
  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-exporter:9104']

  # Redis 监控（需要 redis_exporter）
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

  # MinIO 监控
  - job_name: 'minio'
    static_configs:
      - targets: ['minio:9000']
    metrics_path: '/minio/v2/metrics/cluster'

  # OpenMetadata 监控
  - job_name: 'openmetadata'
    static_configs:
      - targets: ['openmetadata:8585']
    metrics_path: '/api/v1/system/metrics'
    scrape_interval: 30s

  # Elasticsearch 监控
  - job_name: 'elasticsearch'
    static_configs:
      - targets: ['elasticsearch:9200']
    metrics_path: '/_prometheus/metrics'
    scrape_interval: 30s

  # Milvus Vector DB 监控
  - job_name: 'milvus'
    static_configs:
      - targets: ['milvus:9091']
    metrics_path: '/metrics'
    scrape_interval: 30s

  # Node Exporter（主机监控）
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
