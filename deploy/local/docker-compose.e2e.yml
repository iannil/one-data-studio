# =============================================================================
# ONE-DATA-STUDIO E2E 测试环境配置
# =============================================================================
#
# 功能：端到端测试独立环境，包含数据库、后台服务和前端应用
# 端口分配：
#   - MySQL E2E: 3310 (独立端口，避免冲突)
#   - PostgreSQL E2E: 5438 (独立端口，避免冲突)
#   - Data API: 8001
#   - Web: 3000
#
# 使用方法：
#   # 启动完整环境
#   docker-compose -f docker-compose.e2e.yml up -d
#
#   # 生成测试数据
#   docker-compose -f docker-compose.e2e.yml --profile generate up test-data-generator
#
#   # 停止服务（保留数据）
#   docker-compose -f docker-compose.e2e.yml stop
#
#   # 清理环境（删除数据）
#   docker-compose -f docker-compose.e2e.yml down -v
#
# =============================================================================

version: '3.8'

services:
  # ============================================
  # E2E 测试数据库 - MySQL (端口 3310)
  # ============================================
  mysql-e2e:
    image: mysql:8.0
    container_name: e2e-mysql
    ports:
      - "3310:3306"
    environment:
      MYSQL_ROOT_PASSWORD: e2eroot123
      MYSQL_DATABASE: e2e_ecommerce
    volumes:
      - e2e_mysql_data:/var/lib/mysql
      - ../../scripts/test_data/init_e2e_mysql.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-pe2eroot123"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - e2e-network
    restart: unless-stopped

  # ============================================
  # E2E 测试数据库 - PostgreSQL (端口 5438)
  # ============================================
  postgres-e2e:
    image: postgres:15.4
    container_name: e2e-postgres
    ports:
      - "5438:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: e2epostgres123
      POSTGRES_DB: e2e_ecommerce_pg
      POSTGRES_MULTIPLE_DATABASES: e2e_user_mgmt_pg,e2e_logs_pg
    volumes:
      - e2e_postgres_data:/var/lib/postgresql/data
      - ../../scripts/test_data/init_e2e_postgres.sh:/docker-entrypoint-initdb.d/01-init-postgres.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - e2e-network
    restart: unless-stopped

  # ============================================
  # Redis (可选，用于缓存)
  # ============================================
  redis-e2e:
    image: redis:7-alpine
    container_name: e2e-redis
    command: redis-server --requirepass e2eredis123
    ports:
      - "6383:6379"
    volumes:
      - e2e_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "e2eredis123", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - e2e-network
    restart: unless-stopped

  # ============================================
  # 后台服务 - Data API (数据治理 API)
  # ============================================
  data-api-e2e:
    build:
      context: ../../services/data-api
      dockerfile: Dockerfile
    container_name: e2e-data-api
    ports:
      - "8001:8001"
    environment:
      # 数据库配置
      DATABASE_URL: mysql+pymysql://root:e2eroot123@mysql-e2e:3306/onedata
      MYSQL_HOST: mysql-e2e
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASSWORD: e2eroot123

      # PostgreSQL 配置
      POSTGRES_HOST: postgres-e2e
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: e2epostgres123

      # Redis 配置
      REDIS_HOST: redis-e2e
      REDIS_PORT: 6379
      REDIS_PASSWORD: e2eredis123

      # 应用配置
      ENVIRONMENT: development
      AUTH_MODE: "false"  # E2E 测试环境关闭认证
      LOG_LEVEL: INFO
    depends_on:
      mysql-e2e:
        condition: service_healthy
      postgres-e2e:
        condition: service_healthy
      redis-e2e:
        condition: service_healthy
    volumes:
      - ../../services/data-api:/app
      - /app/__pycache__
    networks:
      - e2e-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # 前端应用 (可选)
  # ============================================
  web-e2e:
    build:
      context: ../../web
      dockerfile: Dockerfile
    container_name: e2e-web
    ports:
      - "3000:3000"
    environment:
      VITE_API_BASE_URL: http://localhost:8001
      NODE_ENV: development
    depends_on:
      data-api-e2e:
        condition: service_healthy
    volumes:
      - ../../web:/app
      - /app/node_modules
      - /app/.next
    networks:
      - e2e-network
    restart: unless-stopped
    profiles:
      - web  # 使用 --profile web 启动前端

  # ============================================
  # 测试数据生成服务 (一次性执行)
  # ============================================
  test-data-generator:
    build:
      context: ../../scripts/test_data
      dockerfile: Dockerfile.e2e
    container_name: e2e-data-generator
    environment:
      # MySQL 配置
      MYSQL_HOST: mysql-e2e
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASSWORD: e2eroot123

      # PostgreSQL 配置
      POSTGRES_HOST: postgres-e2e
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: e2epostgres123

      # 数据量配置
      DATA_COUNT: 20000
      USER_COUNT: 1500
      PRODUCT_COUNT: 800
      ORDER_COUNT: 2500
      ORDER_ITEM_COUNT: 5000
      LOG_COUNT: 10000
    depends_on:
      mysql-e2e:
        condition: service_healthy
      postgres-e2e:
        condition: service_healthy
    networks:
      - e2e-network
    profiles:
      - generate  # 使用 --profile generate 启动

volumes:
  e2e_mysql_data:
    name: e2e_mysql_data
  e2e_postgres_data:
    name: e2e_postgres_data
  e2e_redis_data:
    name: e2e_redis_data

networks:
  e2e-network:
    name: e2e-network
    driver: bridge
