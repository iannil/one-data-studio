# ONE-DATA-STUDIO LLMOps Stage Services
#
# This file contains LLMOps stage services with port prefix 83xx
# Services include: agent-api, openai-proxy, admin-api, web-frontend, keycloak
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.llmops.yml --profile llmops up -d

version: '3.8'

services:

  # ============================================
  # LLMOps: Vector Database (Milvus) - Shared with DataOps
  # ============================================
  milvus:
    container_name: one-data-milvus-llmops
    ports:
      - "19530:19530"
      - "9091:9091"
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: ${MINIO_ROOT_USER:?MINIO_ROOT_USER must be set}
      MINIO_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:?MINIO_ROOT_PASSWORD must be set}
    volumes:
      - milvus_data_llmops:/var/lib/milvus
    networks:
      - one-data-network
    profiles:
      - llmops

  etcd:
    container_name: one-data-etcd-llmops
    volumes:
      - etcd_data_llmops:/etcd
    networks:
      - one-data-network
    profiles:
      - llmops

  # ============================================
  # LLMOps: Agent Orchestration API
  # ============================================
  agent-api:
    build:
      context: ../../
      dockerfile: deploy/dockerfiles/agent-api/Dockerfile
    container_name: one-data-agent-api-llmops
    environment:
      DATABASE_URL: mysql+pymysql://${MYSQL_USER:-onedata}:${MYSQL_PASSWORD:?MYSQL_PASSWORD must be set}@mysql:3306/${MYSQL_DATABASE:-onedata}
      REDIS_URL: redis://:${REDIS_PASSWORD:?REDIS_PASSWORD must be set}@redis:6379/0
      MILVUS_HOST: milvus
      MILVUS_PORT: 19530
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:?MINIO_ROOT_USER must be set}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:?MINIO_ROOT_PASSWORD must be set}
      MODEL_API_URL: ${MODEL_API_URL:-http://openai-proxy:8000}
      VLLM_CHAT_URL: ${VLLM_CHAT_URL:-http://vllm-chat:8000}
      VLLM_EMBED_URL: ${VLLM_EMBED_URL:-http://vllm-embed:8000}
      CHAT_MODEL: ${VLLM_CHAT_MODEL:-Qwen/Qwen2.5-1.5B-Instruct}
      EMBEDDING_MODEL: ${VLLM_EMBED_MODEL:-BAAI/bge-base-zh-v1.5}
      EMBEDDING_DIM: ${EMBEDDING_DIM:-768}
      VECTOR_ENABLED: ${VECTOR_ENABLED:-true}
      VECTOR_FALLBACK_ENABLED: ${VECTOR_FALLBACK_ENABLED:-true}
      EMBEDDING_MOCK_ENABLED: ${EMBEDDING_MOCK_ENABLED:-false}
      PORT: 8000
      AUTH_MODE: "false"
    ports:
      - "8300:8000"
    networks:
      - one-data-network
    profiles:
      - llmops

  # ============================================
  # LLMOps: Data Governance API (Shared)
  # ============================================
  data-api:
    build:
      context: ../../
      dockerfile: deploy/dockerfiles/data-api/Dockerfile
    container_name: one-data-data-api-llmops
    volumes:
      - ge_data_llmops:/data/ge
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-onedata}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:?MYSQL_PASSWORD must be set}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-onedata}
      REDIS_URL: redis://:${REDIS_PASSWORD:?REDIS_PASSWORD must be set}@redis:6379/0
      PORT: 8001
      AUTH_MODE: "false"
      OPENMETADATA_HOST: openmetadata
      OPENMETADATA_PORT: 8585
      OPENMETADATA_ENABLED: ${OPENMETADATA_ENABLED:-true}
      VLLM_CHAT_URL: ${VLLM_CHAT_URL:-http://vllm-chat:8000}
      VLLM_CHAT_MODEL: ${VLLM_CHAT_MODEL:-Qwen/Qwen2.5-1.5B-Instruct}
      AI_FEATURES_ENABLED: ${AI_FEATURES_ENABLED:-true}
      KETTLE_CARTE_URL: ${KETTLE_CARTE_URL:-http://kettle:8181}
      KETTLE_CARTE_USER: ${KETTLE_CARTE_USER:-cluster}
      KETTLE_CARTE_PASSWORD: ${KETTLE_CARTE_PASSWORD:?KETTLE_CARTE_PASSWORD must be set}
      KETTLE_ENABLED: ${KETTLE_ENABLED:-true}
      GE_ENABLED: ${GE_ENABLED:-false}
      GE_CONTEXT_ROOT_DIR: /data/ge
      HOP_SERVER_URL: ${HOP_SERVER_URL:-http://hop-server:8182}
      HOP_SERVER_USER: ${HOP_SERVER_USER:-cluster}
      HOP_SERVER_PASSWORD: ${HOP_SERVER_PASSWORD:-cluster}
      HOP_ENABLED: ${HOP_ENABLED:-false}
      ETL_ENGINE: ${ETL_ENGINE:-auto}
      SHARDINGSPHERE_PROXY_URL: ${SHARDINGSPHERE_PROXY_URL:-shardingsphere-proxy:3307}
      SHARDINGSPHERE_ADMIN_URL: ${SHARDINGSPHERE_ADMIN_URL:-http://shardingsphere-proxy:33071}
      SHARDINGSPHERE_USER: ${SHARDINGSPHERE_USER:-root}
      SHARDINGSPHERE_PASSWORD: ${SHARDINGSPHERE_PASSWORD:-root}
      SHARDINGSPHERE_ENABLED: ${SHARDINGSPHERE_ENABLED:-false}
    ports:
      - "8301:8001"
    networks:
      - one-data-network
    profiles:
      - llmops

  # ============================================
  # LLMOps: OpenAI Compatible Proxy
  # ============================================
  openai-proxy:
    build:
      context: ../../
      dockerfile: deploy/dockerfiles/openai-proxy/Dockerfile
    container_name: one-data-openai-proxy-llmops
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD:?REDIS_PASSWORD must be set}@redis:6379/0
      AUTH_MODE: "false"
      VLLM_CHAT_URL: ${VLLM_CHAT_URL:-http://vllm-chat:8000}
      VLLM_EMBED_URL: ${VLLM_EMBED_URL:-http://vllm-embed:8000}
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      LLM_BACKEND: ${LLM_BACKEND:-auto}
      DEFAULT_CHAT_MODEL: ${VLLM_CHAT_MODEL:-Qwen/Qwen2.5-1.5B-Instruct}
      DEFAULT_EMBED_MODEL: ${VLLM_EMBED_MODEL:-BAAI/bge-base-zh-v1.5}
    ports:
      - "8303:8000"
    networks:
      - one-data-network
    profiles:
      - llmops

  # ============================================
  # LLMOps: Admin Backend API
  # ============================================
  admin-api:
    build:
      context: ../../
      dockerfile: deploy/dockerfiles/admin-api/Dockerfile
    container_name: one-data-admin-api-llmops
    volumes:
      - ../../services/admin-api:/app
    environment:
      DATABASE_URL: mysql+pymysql://${MYSQL_USER:-onedata}:${MYSQL_PASSWORD:?MYSQL_PASSWORD must be set}@mysql:3306/${MYSQL_DATABASE:-onedata}
      REDIS_URL: redis://:${REDIS_PASSWORD:?REDIS_PASSWORD must be set}@redis:6379/0
      PORT: 8004
      AUTH_MODE: "false"
      STRICT_AUTH_MODE: "false"
    ports:
      - "8304:8004"
    networks:
      - one-data-network
    profiles:
      - llmops

  # ============================================
  # LLMOps: Web Frontend
  # ============================================
  web-frontend:
    build:
      context: ../../web
      dockerfile: Dockerfile
      args:
        VITE_AUTH_MODE: keycloak
        VITE_KEYCLOAK_URL: http://localhost:8380
        VITE_KEYCLOAK_REALM: one-data-studio
        VITE_KEYCLOAK_CLIENT_ID: web-frontend
        VITE_ENABLE_MOCK_LOGIN: false
    container_name: one-data-web-llmops
    environment:
      VITE_API_BASE_URL: http://localhost:8300
    ports:
      - "8305:80"
    networks:
      - one-data-network
    profiles:
      - llmops

  # ============================================
  # LLMOps: Authentication (Keycloak)
  # ============================================
  keycloak:
    container_name: one-data-keycloak-llmops
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: mysql
      KC_DB_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE:-onedata}
      KC_DB_USERNAME: ${MYSQL_USER:-onedata}
      KC_DB_PASSWORD: ${MYSQL_PASSWORD:?MYSQL_PASSWORD must be set}
    command: start-dev
    ports:
      - "8380:8080"
    volumes:
      - keycloak_data_llmops:/opt/keycloak/data
    networks:
      - one-data-network
    profiles:
      - llmops

  # ============================================
  # LLMOps: Model Management API
  # ============================================
  model-api:
    build:
      context: ../../
      dockerfile: deploy/dockerfiles/model-api/Dockerfile
    container_name: one-data-model-api-llmops
    volumes:
      - ../../services/model-api:/app
    environment:
      MODEL_DATABASE_URL: mysql+pymysql://${MYSQL_USER:-onedata}:${MYSQL_PASSWORD:?MYSQL_PASSWORD must be set}@mysql:3306/${MYSQL_DATABASE:-onedata}
      REDIS_URL: redis://:${REDIS_PASSWORD:?REDIS_PASSWORD must be set}@redis:6379/0
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:?MINIO_ROOT_USER must be set}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:?MINIO_ROOT_PASSWORD must be set}
      HF_TOKEN: ${HF_TOKEN:-}
      AUTH_MODE: "false"
      LABEL_STUDIO_URL: ${LABEL_STUDIO_URL:-http://label-studio:8080}
      LABEL_STUDIO_API_TOKEN: ${LABEL_STUDIO_API_TOKEN:-}
      PORT: 8002
    ports:
      - "8302:8002"
    networks:
      - one-data-network
    profiles:
      - llmops

volumes:
  # LLMOps specific volumes
  milvus_data_llmops:
    driver: local
  etcd_data_llmops:
    driver: local
  ge_data_llmops:
    driver: local
  keycloak_data_llmops:
    driver: local

networks:
  one-data-network:
    external: false
