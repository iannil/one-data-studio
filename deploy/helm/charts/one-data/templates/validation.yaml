# ONE-DATA-STUDIO Credential Validation Template
# This template validates all required credentials before deployment.
# Validation errors will cause helm install/upgrade to fail.
#
# Usage:
#   helm template . --debug  # To test validation without deploying
#
# Note: This creates a ConfigMap that won't be applied (it's just for validation),
# but will trigger all validation checks during templating.

{{- /* Run all validations during template rendering */ -}}
{{- include "one-data.validateAllCredentials" . -}}

---
# Validation ConfigMap - contains deployment metadata
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "one-data.fullname" . }}-validation
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "one-data.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
data:
  # Deployment metadata (no sensitive data)
  environment: {{ .Values.global.environment | quote }}
  validated-at: {{ now | date "2006-01-02T15:04:05Z07:00" | quote }}
  chart-version: {{ .Chart.Version | quote }}
  app-version: {{ .Chart.AppVersion | default "1.0.0" | quote }}

  # Credential status (only shows if configured, not actual values)
  jwt-configured: {{ if .Values.services.jwtSecretKey }}"true"{{ else }}"false"{{ end }}
  minio-configured: {{ if and .Values.infrastructure.minio.credentials.rootUser .Values.infrastructure.minio.credentials.rootPassword }}"true"{{ else }}"false"{{ end }}
  mysql-configured: {{ if .Values.infrastructure.mysql.database.password }}"true"{{ else }}"false"{{ end }}
  redis-configured: {{ if .Values.infrastructure.redis.password }}"true"{{ else }}"false"{{ end }}
  grafana-configured: {{ if .Values.monitoring.grafana.adminPassword }}"true"{{ else }}"false"{{ end }}

  # Security configuration
  is-production: {{ if include "one-data.isProduction" . }}"true"{{ else }}"false"{{ end }}
  tls-enabled: {{ if and .Values.alldata.ingress.tls .Values.bisheng.ingress.tls }}"true"{{ else }}"false"{{ end }}
