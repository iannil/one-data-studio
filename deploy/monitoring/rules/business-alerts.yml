# 业务监控告警规则
# 针对 ONE-DATA-STUDIO 业务指标的告警配置

groups:
  # ============================================
  # Data API 业务告警
  # ============================================
  - name: data_business_alerts
    interval: 30s
    rules:
      # 数据扫描异常
      - alert: DataScanFailureRateHigh
        expr: |
          (
            sum(rate(data_scan_errors_total[5m])) /
            sum(rate(data_scan_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          service: data-api
          category: data_quality
        annotations:
          summary: "数据扫描失败率过高"
          description: "过去 5 分钟数据扫描失败率为 {{ $value | humanizePercentage }}，超过 10% 阈值"

      # 数据同步延迟
      - alert: DataSyncLagHigh
        expr: |
          data_metadata_sync_lag_seconds > 3600
        for: 10m
        labels:
          severity: warning
          service: data-api
          category: sync
        annotations:
          summary: "元数据同步延迟过高"
          description: "元数据同步延迟 {{ $value | humanizeDuration }}，超过 1 小时"

      # ETL 作业失败
      - alert: DataETLJobFailure
        expr: |
          kettle_job_status{status="failed"} > 0
        for: 1m
        labels:
          severity: critical
          service: data-api
          category: etl
        annotations:
          summary: "ETL 作业执行失败"
          description: "作业 {{ $labels.job_name }} 执行失败"

      # ETL 作业积压
      - alert: DataETLJobBacklog
        expr: |
          kettle_job_queue_length > 50
        for: 10m
        labels:
          severity: warning
          service: data-api
          category: etl
        annotations:
          summary: "ETL 作业队列积压"
          description: "当前队列中有 {{ $value }} 个作业等待执行"

      # 资产价值计算延迟
      - alert: DataAssetValueCalculationLag
        expr: |
          time() - data_asset_value_last_calculation_timestamp > 86400
        for: 15m
        labels:
          severity: info
          service: data-api
          category: maintenance
        annotations:
          summary: "资产价值计算未更新"
          description: "资产价值已超过 24 小时未更新"

      # 敏感数据扫描异常
      - alert: DataSensitivityScanError
        expr: |
          increase(alldata_sensitivity_scan_errors[1h]) > 10
        for: 5m
        labels:
          severity: warning
          service: data-api
          category: security
        annotations:
          summary: "敏感数据扫描错误过多"
          description: "过去 1 小时内发生 {{ $value }} 次敏感数据扫描错误"

      # 数据脱敏失败
      - alert: AlldataDataMaskingFailure
        expr: |
          rate(alldata_masking_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          service: data-api
          category: security
        annotations:
          summary: "数据脱敏失败率过高"
          description: "数据脱敏操作失败率超过阈值"

      # AI 填充服务异常
      - alert: AlldataAIImputationError
        expr: |
          rate(alldata_ai_imputation_errors[5m]) > 0.05
        for: 10m
        labels:
          severity: warning
          service: data-api
          category: ai_service
        annotations:
          summary: "AI 数据填充服务异常"
          description: "AI 填充请求错误率: {{ $value | humanizePercentage }}"

  # ============================================
  # Agent API 业务告警
  # ============================================
  - name: bisheng_business_alerts
    interval: 30s
    rules:
      # RAG 检索延迟
      - alert: BishengRAGRetrievalSlow
        expr: |
          histogram_quantile(0.95,
            sum(rate(bisheng_rag_retrieval_duration_seconds_bucket[5m])) by (le)
          ) > 5
        for: 5m
        labels:
          severity: warning
          service: agent-api
          category: performance
        annotations:
          summary: "RAG 检索响应缓慢"
          description: "P95 检索延迟 {{ $value | humanizeDuration }}，超过 5 秒"

      # RAG 检索召回率低
      - alert: BishengRAGRecallLow
        expr: |
          (
            sum(rate(bisheng_rag_relevant_documents_total[10m])) /
            sum(rate(bisheng_rag_retrieved_documents_total[10m]))
          ) < 0.7
        for: 15m
        labels:
          severity: warning
          service: agent-api
          category: quality
        annotations:
          summary: "RAG 检索召回率过低"
          description: "召回率 {{ $value | humanizePercentage }}，低于 70%"

      # Text-to-SQL 错误率高
      - alert: BishengTextToSQLErrorRateHigh
        expr: |
          (
            sum(rate(bisheng_text2sql_errors_total[5m])) /
            sum(rate(bisheng_text2sql_total[5m]))
          ) > 0.2
        for: 5m
        labels:
          severity: warning
          service: agent-api
          category: quality
        annotations:
          summary: "Text-to-SQL 错误率过高"
          description: "SQL 生成错误率 {{ $value | humanizePercentage }}"

      # Agent 执行失败
      - alert: BishengAgentExecutionFailure
        expr: |
          rate(bisheng_agent_execution_errors[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: agent-api
          category: agent
        annotations:
          summary: "Agent 执行失败率过高"
          description: "Agent 执行错误率: {{ $value | humanizePercentage }}"

      # 工作流执行积压
      - alert: BishengWorkflowBacklog
        expr: |
          bisheng_workflow_queue_length > 20
        for: 10m
        labels:
          severity: warning
          service: agent-api
          category: workflow
        annotations:
          summary: "工作流队列积压"
          description: "当前有 {{ $value }} 个工作流等待执行"

      # 向量存储异常
      - alert: BishengVectorStoreError
        expr: |
          rate(bisheng_vector_store_errors[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          service: agent-api
          category: infrastructure
        annotations:
          summary: "向量存储异常"
          description: "向量存储操作错误率: {{ $value | humanizePercentage }}"

      # LLM 调用失败
      - alert: BishengLLMCallFailure
        expr: |
          (
            sum(rate(bisheng_llm_errors_total[5m])) /
            sum(rate(bisheng_llm_requests_total[5m]))
          ) > 0.15
        for: 3m
        labels:
          severity: critical
          service: agent-api
          category: llm
        annotations:
          summary: "LLM 调用失败率过高"
          description: "LLM 调用失败率 {{ $value | humanizePercentage }}"

  # ============================================
  # Cube (vLLM) 业务告警
  # ============================================
  - name: cube_business_alerts
    interval: 30s
    rules:
      # 模型服务延迟
      - alert: CubeModelServingSlow
        expr: |
          histogram_quantile(0.95,
            sum(rate(vllm_request_duration_seconds_bucket[5m])) by (le, model)
          ) > 10
        for: 5m
        labels:
          severity: warning
          service: vllm
          category: performance
        annotations:
          summary: "模型服务响应缓慢"
          description: "模型 {{ $labels.model }} P95 延迟 {{ $value | humanizeDuration }}"

      # 模型服务错误率高
      - alert: CubeModelErrorRateHigh
        expr: |
          (
            sum(rate(vllm_request_errors_total[5m])) /
            sum(rate(vllm_requests_total[5m]))
          ) > 0.05
        for: 3m
        labels:
          severity: critical
          service: vllm
          category: quality
        annotations:
          summary: "模型服务错误率过高"
          description: "请求错误率 {{ $value | humanizePercentage }}"

      # Token 吞吐量过低
      - alert: CubeTokenThroughputLow
        expr: |
          sum(rate(vllm_tokens_generated_total[5m])) < 100
        for: 10m
        labels:
          severity: warning
          service: vllm
          category: performance
        annotations:
          summary: "Token 吞吐量过低"
          description: "当前吞吐量 {{ $value | humanize }} tokens/秒"

      # GPU 内存不足
      - alert: CubeGPUMemoryHigh
        expr: |
          (vllm_gpu_memory_used_bytes / vllm_gpu_memory_total_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
          service: vllm
          category: resource
        annotations:
          summary: "GPU 内存使用率过高"
          description: "GPU 内存使用率 {{ $value | humanizePercentage }}"

      # 模型加载失败
      - alert: CubeModelLoadFailure
        expr: |
          increase(vllm_model_load_errors[10m]) > 0
        for: 1m
        labels:
          severity: critical
          service: vllm
          category: model
        annotations:
          summary: "模型加载失败"
          description: "过去 10 分钟内模型加载失败"

  # ============================================
  # 数据质量告警
  # ============================================
  - name: data_quality_alerts
    interval: 1m
    rules:
      # 数据新鲜度异常
      - alert: DataFreshnessIssue
        expr: |
          time() - max(alldata_table_last_updated_timestamp) by (database, table) > 7200
        for: 15m
        labels:
          severity: warning
          category: data_quality
        annotations:
          summary: "数据新鲜度异常"
          description: "表 {{ $labels.database }}.{{ $labels.table }} 超过 2 小时未更新"

      # 数据行数异常下降
      - alert: DataRowCountDrop
        expr: |
          (
            alldata_table_row_count - alldata_table_row_count_offset
          ) < (alldata_table_row_count_baseline * 0.5)
        for: 10m
        labels:
          severity: warning
          category: data_quality
        annotations:
          summary: "数据行数异常下降"
          description: "表 {{ $labels.database }}.{{ $labels.table }} 行数下降超过 50%"

      # 数据完整性检查失败
      - alert: DataIntegrityCheckFailure
        expr: |
          increase(alldata_integrity_check_failures[1h]) > 5
        for: 5m
        labels:
          severity: warning
          category: data_quality
        annotations:
          summary: "数据完整性检查失败"
          description: "过去 1 小时内发生 {{ $value }} 次完整性检查失败"

  # ============================================
  # 血缘追踪告警
  # ============================================
  - name: lineage_alerts
    interval: 1m
    rules:
      # 血缘事件丢失
      - alert: LineageEventLoss
        expr: |
          (
            sum(rate(openlineage_events_received_total[5m])) -
            sum(rate(openlineage_events_persisted_total[5m]))
          ) > 10
        for: 5m
        labels:
          severity: warning
          service: data-api
          category: lineage
        annotations:
          summary: "血缘事件丢失"
          description: "每秒约 {{ $value | humanize }} 个血缘事件未被持久化"

      # 血缘队列积压
      - alert: LineageQueueBacklog
        expr: |
          openlineage_event_queue_size > 1000
        for: 10m
        labels:
          severity: warning
          service: data-api
          category: lineage
        annotations:
          summary: "血缘事件队列积压"
          description: "队列中有 {{ $value }} 个事件待处理"

  # ============================================
  # 存储告警
  # ============================================
  - name: storage_alerts
    interval: 1m
    rules:
      # MinIO 存储空间不足
      - alert: MinIOStorageSpaceLow
        expr: |
          (minio_storage_used_bytes / minio_storage_total_bytes) > 0.85
        for: 10m
        labels:
          severity: warning
          service: minio
          category: storage
        annotations:
          summary: "MinIO 存储空间不足"
          description: "存储使用率 {{ $value | humanizePercentage }}"

      # 对象数量异常
      - alert: MinIOObjectCountAnomaly
        expr: |
          abs(
            rate(minio_objects_total[1h]) -
            rate(minio_objects_total[24h]) offset 1h
          ) / (rate(minio_objects_total[24h]) + 1) > 0.5
        for: 15m
        labels:
          severity: info
          service: minio
          category: storage
        annotations:
          summary: "对象数量变化异常"
          description: "对象创建速率与历史均值偏差超过 50%"

  # ============================================
  # API 网关告警
  # ============================================
  - name: api_gateway_alerts
    interval: 30s
    rules:
      # API 请求错误率高
      - alert: APIGatewayErrorRateHigh
        expr: |
          (
            sum(rate(nginx_http_requests_total{status=~"5.."}[5m])) /
            sum(rate(nginx_http_requests_total[5m]))
          ) > 0.01
        for: 3m
        labels:
          severity: critical
          service: ingress-nginx
          category: api
        annotations:
          summary: "API 网关错误率过高"
          description: "5xx 错误率 {{ $value | humanizePercentage }}"

      # API 响应时间过长
      - alert: APIGatewayLatencyHigh
        expr: |
          histogram_quantile(0.95,
            sum(rate(nginx_http_request_duration_seconds_bucket[5m])) by (le)
          ) > 2
        for: 5m
        labels:
          severity: warning
          service: ingress-nginx
          category: performance
        annotations:
          summary: "API 网关响应缓慢"
          description: "P95 响应时间 {{ $value | humanizeDuration }}"

  # ============================================
  # 业务流程告警
  # ============================================
  - name: business_process_alerts
    interval: 1m
    rules:
      # 数据管道失败
      - alert: DataPipelineFailure
        expr: |
          sum(data_pipeline_job_status{status="failed"}) > 0
        for: 2m
        labels:
          severity: critical
          category: pipeline
        annotations:
          summary: "数据管道执行失败"
          description: "管道 {{ $labels.pipeline_name }} 的作业 {{ $labels.job_name }} 执行失败"

      # 审批工作流超时
      - alert: ApprovalWorkflowTimeout
        expr: |
          time() - max(approval_workflow_created_timestamp) by (workflow_id) > 86400 * 3
        for: 1h
        labels:
          severity: warning
          category: approval
        annotations:
          summary: "审批工作流超时"
          description: "工作流 {{ $labels.workflow_id }} 等待审批超过 3 天"

      # 资产目录未同步
      - alert: AssetCatalogNotSynced
        expr: |
          time() - alldata_asset_catalog_last_sync_timestamp > 43200
        for: 30m
        labels:
          severity: info
          service: data-api
          category: catalog
        annotations:
          summary: "资产目录未同步"
          description: "资产目录已超过 12 小时未同步"
