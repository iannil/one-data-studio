# TLS 证书管理配置
# 使用 cert-manager 自动管理 TLS 证书

---
# cert-manager Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: cert-manager
  labels:
    pod-security.kubernetes.io/enforce: restricted

---
# cert-manager ClusterIssuer (Let's Encrypt Production)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@example.com  # 替换为实际邮箱
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx

---
# cert-manager ClusterIssuer (Let's Encrypt Staging)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: admin@example.com  # 替换为实际邮箱
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
    - http01:
        ingress:
          class: nginx

---
# 自签名 CA (用于开发环境)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-ca
spec:
  selfSigned: {}

---
# CA 证书颁发者 (用于内部服务)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: internal-ca
spec:
  ca:
    secretName: internal-ca-tls

---
# Alldata API TLS Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: alldata-api-tls
  namespace: one-data-alldata
spec:
  secretName: alldata-api-tls
  duration: 2160h  # 90 days
  renewBefore: 720h  # 30 days before expiration
  commonName: alldata.example.com
  dnsNames:
  - alldata.example.com
  - alldata-api.one-data-alldata.svc.cluster.local
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer

---
# Bisheng API TLS Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: bisheng-api-tls
  namespace: one-data-bisheng
spec:
  secretName: bisheng-api-tls
  duration: 2160h
  renewBefore: 720h
  commonName: bisheng.example.com
  dnsNames:
  - bisheng.example.com
  - bisheng-api.one-data-bisheng.svc.cluster.local
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer

---
# Cube API TLS Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: cube-api-tls
  namespace: one-data-cube
spec:
  secretName: cube-api-tls
  duration: 2160h
  renewBefore: 720h
  commonName: cube.example.com
  dnsNames:
  - cube.example.com
  - vllm-serving.one-data-cube.svc.cluster.local
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer

---
# MinIO Internal TLS Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: minio-tls
  namespace: one-data-infra
spec:
  secretName: minio-tls
  duration: 8760h  # 1 year for internal services
  renewBefore: 720h
  commonName: minio.one-data-infra.svc.cluster.local
  dnsNames:
  - minio.one-data-infra.svc.cluster.local
  - minio
  ipAddresses:
  - 127.0.0.1
  issuerRef:
    name: internal-ca
    kind: ClusterIssuer

---
# MySQL TLS Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: mysql-tls
  namespace: one-data-infra
spec:
  secretName: mysql-tls
  duration: 8760h
  renewBefore: 720h
  commonName: mysql.one-data-infra.svc.cluster.local
  dnsNames:
  - mysql.one-data-infra.svc.cluster.local
  - mysql
  issuerRef:
    name: internal-ca
    kind: ClusterIssuer

---
# Milvus TLS Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: milvus-tls
  namespace: one-data-infra
spec:
  secretName: milvus-tls
  duration: 8760h
  renewBefore: 720h
  commonName: milvus.one-data-infra.svc.cluster.local
  dnsNames:
  - milvus.one-data-infra.svc.cluster.local
  - milvus
  issuerRef:
    name: internal-ca
    kind: ClusterIssuer

---
# Redis TLS Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: redis-tls
  namespace: one-data-infra
spec:
  secretName: redis-tls
  duration: 8760h
  renewBefore: 720h
  commonName: redis.one-data-infra.svc.cluster.local
  dnsNames:
  - redis.one-data-infra.svc.cluster.local
  - redis
  issuerRef:
    name: internal-ca
    kind: ClusterIssuer

---
# Internal CA Secret (预置)
apiVersion: v1
kind: Secret
metadata:
  name: internal-ca-tls
  namespace: one-data-infra
type: kubernetes.io/tls
# 生成命令:
# openssl genrsa -out ca.key 2048
# openssl req -x509 -new -nodes -key ca.key -subj "/CN=internal-ca" -days 3650 -out ca.crt
# kubectl create secret tls internal-ca-tls --cert=ca.crt --key=ca.key -n one-data-infra
# data:
#   tls.crt: <base64 ca.crt>
#   tls.key: <base64 ca.key>

---
# TLS 配置 ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: tls-config
  namespace: one-data-infra
data:
  # TLS 版本要求
  TLS_MIN_VERSION: "1.3"
  TLS_CIPHER_SUITES: "TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256"

  # 证书轮换配置
  CERT_ROTATION_ENABLED: "true"
  CERT_ROTATION_CHECK_INTERVAL: "24h"
  CERT_EXPIRY_WARNING_DAYS: "30"

  # OCSP 配置
  OCSP_ENABLED: "false"
  OCSP_CACHE_DURATION: "1h"

  # mTLS 配置
  MTLS_ENABLED: "false"
  MTLS_CA_SECRET: "internal-ca-tls"
