# ONE-DATA-STUDIO API Gateway
# Sprint 3.5: Istio 统一 API 入口

---
# API Gateway
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: api-gateway
  namespace: one-data-system
spec:
  selector:
    istio: ingressgateway
  servers:
  - name: http
    port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "api.one-data.local"
  - name: https
    port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "api.one-data.local"
    tls:
      mode: SIMPLE
      credentialName: api-gateway-tls  # 需要提前创建 Secret

---
# VirtualService: Alldata API
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: alldata-api-vs
  namespace: one-data-alldata
spec:
  hosts:
  - "api.one-data.local"
  gateways:
  - one-data-system/api-gateway
  http:
  - match:
    - uri:
        prefix: /api/v1/datasets
    - uri:
        prefix: /api/v1/metadata
    route:
    - destination:
        host: alldata-api
        port:
          number: 8080
      weight: 100
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,connect-failure,refused-stream

---
# VirtualService: Cube/OpenAI API
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: openai-api-vs
  namespace: one-data-cube
spec:
  hosts:
  - "api.one-data.local"
  gateways:
  - one-data-system/api-gateway
  http:
  - match:
    - uri:
        prefix: /v1/
    route:
    - destination:
        host: openai-proxy
        port:
          number: 8000
      weight: 100
    timeout: 60s
    retries:
      attempts: 2
      perTryTimeout: 30s
      retryOn: 5xx,connect-failure,refused-stream

---
# VirtualService: Bisheng API
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bisheng-api-vs
  namespace: one-data-bisheng
spec:
  hosts:
  - "api.one-data.local"
  gateways:
  - one-data-system/api-gateway
  http:
  - match:
    - uri:
        prefix: /api/v1/chat
    - uri:
        prefix: /api/v1/workflows
    - uri:
        prefix: /api/v1/rag
    - uri:
        prefix: /api/v1/sql
    route:
    - destination:
        host: bisheng-api
        port:
          number: 8081
      weight: 100
    timeout: 60s
    retries:
      attempts: 2
      perTryTimeout: 30s
      retryOn: 5xx,connect-failure,refused-stream

---
# DestinationRule: Alldata API
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: alldata-api-dr
  namespace: one-data-alldata
spec:
  host: alldata-api
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
        idleTimeout: 60s
    outlierDetection:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50

---
# DestinationRule: OpenAI Proxy
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: openai-proxy-dr
  namespace: one-data-cube
spec:
  host: openai-proxy
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
        idleTimeout: 60s
    outlierDetection:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50

---
# DestinationRule: Bisheng API
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: bisheng-api-dr
  namespace: one-data-bisheng
spec:
  host: bisheng-api
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
        idleTimeout: 60s
    outlierDetection:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50

---
# ServiceEntry: External OpenAI API (可选)
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: external-openai-api
  namespace: one-data-system
spec:
  hosts:
  - api.openai.com
  location: MESH_EXTERNAL
  ports:
  - number: 443
    name: https
    protocol: HTTPS
  resolution: DNS

---
# RequestAuthentication: JWT 认证策略
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: one-data-system
spec:
  selector:
    matchLabels:
      app: api-gateway
  jwtRules:
  - issuer: "http://keycloak.one-data.local/realms/one-data-studio"
    jwks: |
      {
        "keys": [
          {
            "kty": "RSA",
            "e": "AQAB",
            "use": "sig",
            "kid": "one-data-studio-key",
            "alg": "RS256",
            "n": "..."
          }
        ]
      }
    fromHeaders:
    - name: Authorization
      prefix: "Bearer "
    outputPayloadToHeader: x-jwt-payload

---
# AuthorizationPolicy: 基于 JWT 角色的访问控制
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: api-authz
  namespace: one-data-system
spec:
  selector:
    matchLabels:
      app: api-gateway
  action: ALLOW
  rules:
  # 允许健康检查
  - to:
    - operation:
        paths: ["/health", "/metrics"]
  # 允许已认证用户访问 API
  - when:
    - key: request.auth.claims[preferred_username]
      values: ["*"]
  # 特定路径需要特定角色
  - to:
    - operation:
        paths: ["/api/v1/datasets", "/api/v1/datasets/*"]
    when:
    - key: request.auth.claims[realm_access.roles]
      values: ["user", "data_engineer", "data_analyst", "admin"]
  - to:
    - operation:
        methods: ["POST", "PUT", "DELETE"]
        paths: ["/api/v1/datasets*"]
    when:
    - key: request.auth.claims[realm_access.roles]
      values: ["data_engineer", "admin"]
  - to:
    - operation:
        paths: ["/api/v1/chat", "/api/v1/rag/*", "/api/v1/workflows*"]
    when:
    - key: request.auth.claims[realm_access.roles]
      values: ["ai_developer", "user", "admin"]
