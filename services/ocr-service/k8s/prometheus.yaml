apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-ocr-config
  namespace: monitoring
data:
  ocr-service.json: |
    {
      "scrape_configs": [
        {
          "job_name": "ocr-service",
          "kubernetes_sd_configs": [
            {
              "role": "pod",
              "namespaces": {
                "names": ["ocr-service"]
              }
            }
          ],
          "relabel_configs": [
            {
              "source_labels": ["__meta_kubernetes_pod_label_app"],
              "action": "keep",
              "regex": "ocr-service"
            },
            {
              "source_labels": ["__meta_kubernetes_pod_name"],
              "action": "replace",
              "target_label": "pod"
            },
            {
              "source_labels": ["__meta_kubernetes_namespace"],
              "action": "replace",
              "target_label": "namespace"
            },
            {
              "source_labels": ["__meta_kubernetes_pod_node_name"],
              "action": "replace",
              "target_label": "node"
            }
          ],
          "metrics_path": "/metrics",
          "scheme": "http",
          "relabel_configs": [
            {
              "source_labels": ["__meta_kubernetes_pod_annotation_prometheus_io_scrape"],
              "action": "keep",
              "regex": "true"
            },
            {
              "source_labels": ["__meta_kubernetes_pod_annotation_prometheus_io_path"],
              "action": "replace",
              "target_label": "__metrics_path__",
              "regex": "(.+)"
            },
            {
              "source_labels": ["__address__", "__meta_kubernetes_pod_annotation_prometheus_io_port"],
              "action": "replace",
              "regex": "([^:]+)(?::\\d+)?;(\$$)",
              "target_label": "__address__",
              "replacement": "$1:8007"
            },
            {
              "source_labels": ["__meta_kubernetes_pod_name"],
              "action": "replace",
              "target_label": "instance"
            }
          ]
        }
      ]
    }
