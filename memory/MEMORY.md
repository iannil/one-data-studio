# ONE-DATA-STUDIO 长期记忆

> 本文件存储项目的长期知识、决策和上下文。

## 项目概述

ONE-DATA-STUDIO 是一个企业级 DataOps + MLOps + LLMOps 融合平台。

### 核心特点

- 完整的前后端实现
- 主要使用中文编写文档
- 使用 Mermaid 图表可视化工作流程
- 支持 Docker Compose 和 Kubernetes 部署

### 四层架构

1. L1 基础设施层: Kubernetes 容器编排，CPU/GPU 资源池
2. L2 数据底座层 (Data): 数据集成、ETL、治理、特征存储、向量存储
3. L3 算法引擎层 (Model): Notebook 开发、分布式训练、模型服务
4. L4 应用编排层 (Agent): RAG 流水线、Agent 编排、Prompt 管理

## 用户偏好

### 编码风格

- 不可变性优先: 始终创建新对象，永不突变
- 小文件组织: 高内聚低耦合，200-400 行典型，800 行最大
- 类型安全: 显式类型，运行时与编译时契约一致
- 声明式配置: 减少分支，数据驱动

### 工作流偏好

- TDD 强制: 先写测试，80%+ 覆盖率
- 计划驱动: 复杂任务先规划
- 小步提交: 便于理解和回滚
- 并行执行: 独立操作使用并行 Task

### 文档规范

- 中文交流与文档
- 代码使用英文
- 文档放在 `docs` 文件夹
- 进度保存到 `/docs/progress`（未完成）
- 完成报告保存到 `/docs/reports/completed`

### 发布规范

- 固定在 `/release` 文件夹
- 必须包含生产环境所需的所有文件
- 支持全量和增量发布

## 关键决策

### 记忆系统

- 决策: 使用基于 Markdown 的透明双层记忆
- 原因: 禁止复杂嵌入检索，保持人类可读和 Git 友好
- 结构:
  - 流层: `memory/daily/{YYYY-MM-DD}.md` - 仅追加日志
  - 沉积层: `memory/MEMORY.md` - 结构化知识

### 面向 LLM 可改写性

- 一致的分层与目录
- 明确边界与单一职责
- 显式类型与契约优先
- 统一命名约定（parseXxx、assertNever、createXxxService）

## 项目结构

```
one-data-studio/
├── services/         # 后端服务（Flask/FastAPI）
│   ├── data-api/     # 数据治理 API
│   ├── agent-api/    # 应用编排 API
│   ├── openai-proxy/ # OpenAI 兼容代理
│   └── ...
├── web/              # 前端应用（React + TypeScript + Vite）
├── deploy/           # 部署配置
├── tests/            # 测试用例
├── docs/             # 项目文档
├── memory/           # 记忆系统
└── scripts/          # 运维脚本
```

## 项目完成度（2026-02-12）

### 服务状态

| 服务 | 状态 | 文件数 | 代码行数 |
|------|------|--------|----------|
| data-api | ✅ 生产就绪 | 90 | 69,054 |
| agent-api | ✅ 生产就绪 | 56 | 23,462 |
| model-api | ✅ 生产就绪 | 24 | 10,304 |
| admin-api | ✅ 生产就绪 | 25 | 10,316 |
| openai-proxy | ✅ 生产就绪 | 1 | 890 |
| ocr-service | ✅ 已完成 | 33 | 11,503 |
| behavior-service | ✅ 已完成 | 11 | 3,058 |
| shared | ✅ 生产就绪 | 62 | ~90,000 |

所有后端服务 100% 完成

### 最近完成的工作

| 日期 | 工作内容 | 成果 |
|------|----------|------|
| 2026-02-12 | 文档整理 | 归档过期文档，移动 test-specs 到正确位置 |
| 2026-02-09 | DataOps 功能测试规范 | 321 个功能的完整测试规范 |
| 2026-02-09 | 认证模块统一 | 3 个服务的 auth.py 统一到 shared/auth |
| 2026-02-09 | console.log 清理 | 32 个 E2E 测试文件的日志规范化 |
| 2026-02-08 | DataOps E2E 全流程测试 | 完整的数据管道验证 |
| 2026-02-07 | 用户生命周期测试 | 自动化测试脚本 |
| 2026-02-07 | OCR 验证实现 | 文档识别验证 |

### 最近修复的问题

| 日期 | 问题 | 修复 |
|------|------|------|
| 2026-02-09 | 认证模块重复 | 统一到 shared/auth，保持向后兼容 |
| 2026-02-09 | console.log 泛滥 | 32 个文件替换为 logger |
| 2026-02-04 | 向量检索使用模拟数据 | 添加环境变量控制向量服务启用 |
| 2026-02-04 | 聊天历史加载缺少错误处理 | 添加错误处理和日志记录 |
| 2026-02-04 | 向量删除不完整 | 添加参数验证、SQL 注入防护 |
| 2026-02-06 | Lint 警告过多 (547) | 清理未使用导入，降至 499 |

### 分阶段测试计划

- 状态: ✅ 已实施
- 目的: 资源受限环境（16GB 内存）下的分阶段验证
- 成果:
  - 环境变量模板 (`deploy/local/.env.example`)
  - 自动化测试脚本 (`deploy/local/test-phased.sh`)
  - 6 个阶段集成测试文件 (205 测试用例)
  - 完整测试指南文档

### 代码质量改进

| 项目 | 改进前 | 改进后 |
|------|--------|--------|
| Lint 警告 | 547 | 499 (-48) |
| 认证模块 | 3 个独立实现 | 统一到 shared/auth |
| console.log | 32 个文件 | 已替换为 logger |
| 测试通过率 | 1361/1371 (99.3%) | 目标 100% |

## 当前技术债务

### 代码清理已完成

1. ~~认证模块重复: 3 个服务有独立 auth.py 实现~~ ✅ 已统一到 `services/shared/auth/`

2. ~~console.log 清理: 12 个 E2E 测试文件需要替换为 logger~~ ✅ 已完成（32 个文件）

3. ~~注释代码清理:~~ ✅ 检查后无需清理

### 待改进功能

| 优先级 | 功能 | 位置 |
|--------|------|------|
| P1 | 工作流编辑器完善 | `web/src/pages/workflows/` |
| P1 | 模型热切换 | `services/openai-proxy/` |
| P2 | 数据集版本控制 | `services/data-api/` |
| P2 | 自动触发训练 | `services/model-api/` |

## 经验教训

> 避免重复过去的错误

1. 认证逻辑应该共享: 多个服务各自实现 auth.py 导致维护困难（已修复：统一到 shared/auth）
2. 测试环境资源限制: 16GB 内存无法同时运行所有服务，需要分阶段测试
3. console.log 在 E2E 测试中应统一: 便于调试和日志管理（已修复：替换为 logger）
4. 避免同名类定义: BehaviorAnalyzer 在两个服务中重复定义，需要重命名或合并

## 已识别的冗余内容

### P1 优先级

| 问题 | 位置 | 建议操作 |
|------|------|----------|
| BehaviorAnalyzer 重复定义 | admin-api, behavior-service | 重命名为不同名称或合并 |

### P2 优先级

| 问题 | 位置 | 建议操作 |
|------|------|----------|
| TestConfig 重复 (8处) | tests/integration/ | 提取到 conftest.py |
| UserProfile 模型重复 | behavior-service, admin-api | 评估是否需要统一 |

### P3 优先级

| 问题 | 位置 | 建议操作 |
|------|------|----------|
| TODO 注释 (9处) | data-api, agent-api, ocr-service | 转换为 GitHub Issues |

## 最后更新

- 日期: 2026-02-12
- 操作: 文档深度整理、移动过期文档、更新技术债务状态、文档健康度提升至 5.0/5.0
