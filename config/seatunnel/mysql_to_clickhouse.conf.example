# SeaTunnel CDC 配置示例: MySQL 到 ClickHouse
#
# 用途：实时同步 MySQL 变更数据到 ClickHouse 数仓
# 适用场景：实时数仓、OLAP 分析
#
# 使用方法：
# 1. 复制本文件并修改数据库连接信息
# 2. 通过 SeaTunnel API 提交任务

env {
  job.mode = "STREAMING"
  parallelism = 2
  checkpoint.interval = 3000
}

source {
  MySQL-CDC {
    result_table_name = "mysql_cdc_source"

    # MySQL 连接配置
    host = "mysql"
    port = 3306
    username = "onedata"
    password = "password"

    database = "onedata"

    # 表配置
    table-names = [
      "onedata.users",
      "onedata.orders"
    ]

    server-id = 5701
    server-time-zone = "UTC"

    # 仅捕获数据变更，不捕获 DDL
    # snapshot.mode = "schema_only"
  }
}

transform {
  # 表名映射（MySQL 表名 -> ClickHouse 表名）
  # ClickHouse 表需要在目标数据库预先创建

  # 可选：数据清洗和转换
  # FilterRow {
  #   source_table_name = "mysql_cdc_source"
  #   result_table_name = "filtered_data"
  #
  #   # 过滤条件
  #   filter = "deleted = false"
  # }
}

sink {
  # ClickHouse 目标配置
  ClickHouse {
    source_table_name = "mysql_cdc_source"

    # ClickHouse 连接配置
    host = "clickhouse"
    port = 8123
    database = "analytics"

    # 表名映射
    # 实际表名会根据源表动态生成
    table = "${database}_${table}"

    # 认证信息（可选）
    username = "default"
    password = ""

    # 主键配置（用于 upsert）
    primary_key = "id"

    # 批量写入配置
    # sink.batch.size = 1000
    # sink.flush.interval = 30000

    # ClickHouse 特定配置
    # clickhouse.config = "INSERT INTO {table} ({columns}) VALUES ({values})"
  }

  # 如果需要写入不同的 ClickHouse 表，可以为每个表配置独立的 sink
  # ClickHouse {
  #   source_table_name = "mysql_cdc_source"
  #   host = "clickhouse"
  #   port = 8123
  #   database = "analytics"
  #   table = "users"
  #   primary_key = "id"
  #   precondition = "database = 'onedata' AND table = 'users'"
  # }
}
