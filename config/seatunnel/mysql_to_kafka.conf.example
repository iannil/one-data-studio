# SeaTunnel CDC 配置示例: MySQL 到 Kafka
#
# 用途：实时同步 MySQL 变更数据到 Kafka 消息队列
# 适用场景：流处理、事件驱动架构
#
# 使用方法：
# 1. 复制本文件并修改数据库连接信息
# 2. 通过 SeaTunnel API 提交任务

env {
  job.mode = "STREAMING"
  parallelism = 2
  checkpoint.interval = 3000
}

source {
  MySQL-CDC {
    result_table_name = "mysql_cdc_source"

    host = "mysql"
    port = 3306
    username = "onedata"
    password = "password"

    database = "onedata"

    table-names = [
      "onedata.users",
      "onedata.orders"
    ]

    server-id = 5702
    server-time-zone = "UTC"

    # 包含变更类型
    # format.options.includeSchemaChanges = "true"
  }
}

transform {
  # 添加元数据
  {
    source_table_name = "mysql_cdc_source"
    result_table_name = "enriched_data"

    # 添加变更类型和时间戳
    add_field {
      fields = [
        { field_name = "op_type", field_expression = "op_type" },
        { field_name = "event_time", field_expression = "${now()}" }
      ]
    }
  }
}

sink {
  # Kafka 目标配置
  Kafka {
    source_table_name = "enriched_data"

    # Kafka 连接配置
    bootstrap.servers = "kafka:9092"

    # Topic 配置
    # topic = "cdc.mysql"
    topic = "mysql_cdc_${database}_${table}"

    # 数据格式
    format.type = "json"
    # format.options.includeSchema = "true"

    # 分区策略
    # partition_key_fields = ["id"]
    # partitioner = "default"

    # 交付保证
    # kafka.request.timeout.ms = 30000
    # kafka.acks = "all"

    # 重试配置
    # kafka.retries = 3
  }
}
