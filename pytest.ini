[pytest]
# Pytest 配置文件
# Sprint 6: 单元测试框架
# Sprint 22: Quality Assurance - 覆盖率强制

# Python 路径 - 确保 services 模块可被导入
# 使用项目根目录作为基础，确保 from services.xxx import ... 可用
pythonpath =
    .
    services/bisheng-api
    services/alldata-api
    services/alldata-api/src
    services/cube-api
    services/shared
    services/admin-api
    services/openai-proxy

# pytest-asyncio 配置
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function

# 测试目录
testpaths = tests

# 测试文件模式
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# 默认选项（包含覆盖率）
addopts =
    -v
    --strict-markers
    --tb=short
    --disable-warnings
    -p no:warnings
    --cov=services/shared
    --cov=services/alldata-api
    --cov=services/bisheng-api
    --cov-report=term-missing
    --cov-report=html:htmlcov
    --cov-report=xml:coverage.xml
    --cov-fail-under=70

# 最小覆盖率阈值（70% - Sprint 24 目标）
# 在 CI 中启用: pytest --cov-fail-under=70
[coverage:run]
branch = True
source = services
omit =
    */tests/*
    */__init__.py
    */migrations/*
    */engine/tools/*
    */tracer_setup.py

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
fail_under = 80

# 标记定义
markers =
    unit: 单元测试（不依赖外部服务）
    integration: 集成测试（需要外部服务）
    slow: 慢速测试（执行时间较长）
    security: 安全测试
    requires_db: 需要数据库
    requires_milvus: 需要 Milvus
    requires_minio: 需要 MinIO
    requires_auth: 需要认证服务
    requires_redis: 需要 Redis
    asyncio: 异步测试

# 日志配置
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S
