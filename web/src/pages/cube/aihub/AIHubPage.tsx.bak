import { useState } from 'react';
import {
  Card,
  Row,
  Col,
  Input,
  Select,
  Button,
  Tag,
  Space,
  Modal,
  Form,
  Descriptions,
  Drawer,
  Tabs,
  Progress,
  Statistic,
  message,
  Avatar,
  Tooltip,
  Table,
  Spin,
  InputNumber,
} from 'antd';
import {
  SearchOutlined,
  RocketOutlined,
  DownloadOutlined,
  EyeOutlined,
  ApiOutlined,
  StarOutlined,
  DatabaseOutlined,
  CheckCircleOutlined,
  CloudServerOutlined,
  ReloadOutlined,
  FileTextOutlined,
  GithubOutlined,
} from '@ant-design/icons';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import dayjs from 'dayjs';
import cube from '@/services/cube';
import type { HubModel, ModelDeploymentConfig } from '@/services/cube';

const { Search } = Input;
const { Option } = Select;

function AIHubPage() {
  const queryClient = useQueryClient();
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(12);
  const [searchKeyword, setSearchKeyword] = useState('');
  const [taskTypeFilter, setTaskTypeFilter] = useState<string>('');
  const [frameworkFilter, setFrameworkFilter] = useState<string>('');
  const [paramsFilter, setParamsFilter] = useState<string>('');

  const [isDetailDrawerOpen, setIsDetailDrawerOpen] = useState(false);
  const [isDeployModalOpen, setIsDeployModalOpen] = useState(false);
  const [selectedModel, setSelectedModel] = useState<HubModel | null>(null);

  const [deployForm] = Form.useForm();

  // Queries
  const { data: modelsData, isLoading: isLoadingList } = useQuery({
    queryKey: ['hub-models', page, pageSize, searchKeyword, taskTypeFilter, frameworkFilter, paramsFilter],
    queryFn: () =>
      cube.getHubModels({
        page,
        page_size: pageSize,
        search: searchKeyword || undefined,
        task_type: taskTypeFilter || undefined,
        framework: frameworkFilter || undefined,
        parameters: paramsFilter || undefined,
      }),
  });

  const { data: categoriesData } = useQuery({
    queryKey: ['hub-categories'],
    queryFn: () => cube.getHubCategories(),
  });

  // Mutations
  const downloadMutation = useMutation({
    mutationFn: cube.downloadHubModel,
    onSuccess: () => {
      message.success('模型下载任务已创建');
      setIsDetailDrawerOpen(false);
      queryClient.invalidateQueries({ queryKey: ['hub-models'] });
    },
    onError: () => {
      message.error('模型下载失败');
    },
  });

  const deployMutation = useMutation({
    mutationFn: ({ modelId, config }: { modelId: string; config: ModelDeploymentConfig }) =>
      cube.deployHubModel(modelId, config),
    onSuccess: () => {
      message.success('模型部署任务已创建');
      setIsDeployModalOpen(false);
      deployForm.resetFields();
      setIsDetailDrawerOpen(false);
      queryClient.invalidateQueries({ queryKey: ['hub-models'] });
    },
    onError: () => {
      message.error('模型部署失败');
    },
  });

  const getTaskTypeColor = (type: string) => {
    const colors: Record<string, string> = {
      nlp: 'blue',
      cv: 'green',
      multimodal: 'purple',
      audio: 'orange',
      recommendation: 'cyan',
      other: 'default',
    };
    return colors[type] || 'default';
  };

  const getTaskTypeText = (type: string) => {
    const texts: Record<string, string> = {
      nlp: 'NLP',
      cv: '计算机视觉',
      multimodal: '多模态',
      audio: '语音',
      recommendation: '推荐',
      other: '其他',
    };
    return texts[type] || type;
  };

  const getFrameworkColor = (framework: string) => {
    const colors: Record<string, string> = {
      pytorch: 'orange',
      tensorflow: 'orange',
      jax: 'blue',
      onnx: 'green',
      other: 'default',
    };
    return colors[framework] || 'default';
  };

  const getParamsColor = (params: string) => {
    const colors: Record<string, string> = {
      small: 'green',
      medium: 'blue',
      large: 'orange',
      xl: 'red',
    };
    return colors[params] || 'default';
  };

  const getParamsText = (params: string) => {
    const texts: Record<string, string> = {
      small: '小',
      medium: '中',
      large: '大',
      xl: '超大',
    };
    return texts[params] || params;
  };

  const categories = categoriesData?.data?.categories || [];
  const models = modelsData?.data?.models || [];
  const total = modelsData?.data?.total || 0;

  return (
    <div style={{ padding: '24px' }}>
      {/* 搜索和筛选栏 */}
      <Card style={{ marginBottom: 24 }}>
        <Row gutter={16} align="middle">
          <Col span={8}>
            <Search
              placeholder="搜索模型名称、描述..."
              value={searchKeyword}
              onChange={(e) => {
                setSearchKeyword(e.target.value);
                setPage(1);
              }}
              allowClear
              enterButton
            />
          </Col>
          <Col span={4}>
            <Select
              placeholder="任务类型"
              allowClear
              style={{ width: '100%' }}
              onChange={(value) => {
                setTaskTypeFilter(value || '');
                setPage(1);
              }}
            >
              {categories.map((cat) => (
                <Option key={cat.value} value={cat.value}>
                  {cat.label} ({cat.count})
                </Option>
              ))}
            </Select>
          </Col>
          <Col span={4}>
            <Select
              placeholder="框架"
              allowClear
              style={{ width: '100%' }}
              onChange={(value) => {
                setFrameworkFilter(value || '');
                setPage(1);
              }}
            >
              <Option value="pytorch">PyTorch</Option>
              <Option value="tensorflow">TensorFlow</Option>
              <Option value="jax">JAX</Option>
              <Option value="onnx">ONNX</Option>
            </Select>
          </Col>
          <Col span={4}>
            <Select
              placeholder="参数规模"
              allowClear
              style={{ width: '100%' }}
              onChange={(value) => {
                setParamsFilter(value || '');
                setPage(1);
              }}
            >
              <Option value="small">小</Option>
              <Option value="medium">中</Option>
              <Option value="large">大</Option>
              <Option value="xl">超大</Option>
            </Select>
          </Col>
          <Col span={4}>
            <Button icon={<ReloadOutlined />} onClick={() => queryClient.invalidateQueries({ queryKey: ['hub-models'] })}>
              刷新
            </Button>
          </Col>
        </Row>
      </Card>

      {/* 模型网格 */}
      <Row gutter={[16, 16]}>
        {isLoadingList ? (
          <Col span={24}>
            <div style={{ textAlign: 'center', padding: 40 }}>
              <Spin size="large" tip="加载中..." />
            </div>
          </Col>
        ) : models.length === 0 ? (
          <Col span={24}>
            <div style={{ textAlign: 'center', padding: 40, color: '#999' }}>
              没有找到匹配的模型
            </div>
          </Col>
        ) : (
          models.map((model) => (
            <Col key={model.model_id} xs={24} sm={12} md={8} lg={6}>
              <Card
                hoverable
                onClick={() => {
                  setSelectedModel(model);
                  setIsDetailDrawerOpen(true);
                }}
                style={{ height: '100%' }}
                bodyStyle={{ padding: 16 }}
              >
                <div style={{ marginBottom: 12 }}>
                  <Space direction="vertical" size={4}>
                    <div style={{ fontWeight: 'bold', fontSize: 14 }}>{model.display_name}</div>
                    <div style={{ fontSize: 12, color: '#666' }}>{model.description}</div>
                  </Space>
                </div>
                <div style={{ marginBottom: 12 }}>
                  <Space wrap>
                    <Tag color={getTaskTypeColor(model.task_type)}>{getTaskTypeText(model.task_type)}</Tag>
                    <Tag color={getFrameworkColor(model.framework)}>{model.framework}</Tag>
                    <Tag color={getParamsColor(model.parameters)}>{getParamsText(model.parameters)}</Tag>
                  </Space>
                </div>
                {model.accuracy && (
                  <div style={{ marginBottom: 12 }}>
                    <Progress percent={model.accuracy * 100} size="small" />
                    <span style={{ fontSize: 12, color: '#999', marginLeft: 8 }}>
                      准确率: {(model.accuracy * 100).toFixed(1)}%
                    </span>
                  </div>
                )}
                <Row gutter={8}>
                  <Col span={12}>
                    <div style={{ fontSize: 12, color: '#999' }}>
                      <DatabaseOutlined /> {model.downloads.toLocaleString()}
                    </div>
                  </Col>
                  <Col span={12} style={{ textAlign: 'right' }}>
                    <Tooltip title={model.license}>
                      <Tag style={{ cursor: 'pointer' }}>{model.license}</Tag>
                    </Tooltip>
                  </Col>
                </Row>
              </Card>
            </Col>
          ))
        )}
      </Row>

      {/* 分页 */}
      {total > pageSize && (
        <div style={{ textAlign: 'center', marginTop: 24 }}>
          <Button
            onClick={() => setPage((p) => Math.max(1, p - 1))}
            disabled={page === 1}
          >
            上一页
          </Button>
          <span style={{ margin: '0 16px' }}>
            第 {page} / {Math.ceil(total / pageSize)} 页
          </span>
          <Button
            onClick={() => setPage((p) => p + 1)}
            disabled={page * pageSize >= total}
          >
            下一页
          </Button>
        </div>
      )}

      {/* 模型详情抽屉 */}
      <Drawer
        title={selectedModel?.display_name}
        open={isDetailDrawerOpen}
        onClose={() => {
          setIsDetailDrawerOpen(false);
          setSelectedModel(null);
        }}
        width={700}
      >
        {selectedModel && (
          <div>
            <Space direction="vertical" style={{ width: '100%', marginBottom: 24 }} size="large">
              <Card
                title="基本信息"
                size="small"
                extra={
                  <Space>
                    <Button icon={<DownloadOutlined />} loading={downloadMutation.isPending} onClick={() => downloadMutation.mutate(selectedModel.model_id)}>
                      下载模型
                    </Button>
                    <Button
                      type="primary"
                      icon={<RocketOutlined />}
                      onClick={() => {
                        setIsDetailDrawerOpen(false);
                        setIsDeployModalOpen(true);
                      }}
                    >
                      部署服务
                    </Button>
                  </Space>
                }
              >
                <Descriptions column={2} size="small">
                  <Descriptions.Item label="模型ID" span={2}>
                    <Input.TextArea
                      value={selectedModel.model_id}
                      autoSize={{ minRows: 1, maxRows: 2 }}
                      readOnly
                      style={{ fontFamily: 'monospace', fontSize: 12 }}
                    />
                  </Descriptions.Item>
                  <Descriptions.Item label="任务类型">
                    <Tag color={getTaskTypeColor(selectedModel.task_type)}>{getTaskTypeText(selectedModel.task_type)}</Tag>
                  </Descriptions.Item>
                  <Descriptions.Item label="框架">
                    <Tag color={getFrameworkColor(selectedModel.framework)}>{selectedModel.framework}</Tag>
                  </Descriptions.Item>
                  <Descriptions.Item label="参数规模">
                    <Tag color={getParamsColor(selectedModel.parameters)}>{getParamsText(selectedModel.parameters)}</Tag>
                  </Descriptions.Item>
                  {selectedModel.architecture && (
                    <Descriptions.Item label="架构" span={2}>
                      {selectedModel.architecture}
                    </Descriptions.Item>
                  )}
                  {selectedModel.size_bytes && (
                    <Descriptions.Item label="模型大小">
                      {(selectedModel.size_bytes / 1024 / 1024 / 1024).toFixed(2)} GB
                    </Descriptions.Item>
                  )}
                  {selectedModel.author && (
                    <Descriptions.Item label="作者" span={2}>
                      {selectedModel.author}
                    </Descriptions.Item>
                  )}
                  <Descriptions.Item label="下载量" span={2}>
                    {selectedModel.downloads.toLocaleString()}
                  </Descriptions.Item>
                  <Descriptions.Item label="许可证" span={2}>
                    {selectedModel.license}
                  </Descriptions.Item>
                  </Descriptions>
                </Card>

                {selectedModel.benchmarks && selectedModel.benchmarks.length > 0 && (
                  <Card title="基准测试" size="small">
                    <Table
                      columns={[
                        { title: '数据集', dataIndex: 'dataset', key: 'dataset' },
                        { title: '指标', dataIndex: 'metric', key: 'metric' },
                        { title: '分数', dataIndex: 'score', key: 'score', render: (score: number) => score?.toFixed(4) },
                      ]}
                      dataSource={selectedModel.benchmarks}
                      rowKey="dataset"
                      pagination={false}
                      size="small"
                    />
                  </Card>
                )}

                {selectedModel.usage_example && (
                  <Card title="使用示例" size="small">
                    <pre style={{
                      background: '#f5f5f5',
                      padding: 12,
                      borderRadius: 4,
                      fontSize: 12,
                      overflow: 'auto',
                      maxHeight: 200,
                    }}>
                      {selectedModel.usage_example}
                    </pre>
                  </Card>
                )}

                {selectedModel.paper_url && (
                  <Card size="small">
                    <a href={selectedModel.paper_url} target="_blank" rel="noopener noreferrer">
                      <Button icon={<FileTextOutlined />}>阅读论文</Button>
                    </a>
                    {selectedModel.repo_url && (
                      <a href={selectedModel.repo_url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: 8 }}>
                        <Button icon={<GithubOutlined />}>模型仓库</Button>
                      </a>
                    )}
                  </Card>
                )}
              </Space>
            </div>
          )}
        )}
      </Drawer>

      {/* 部署模型模态框 */}
      <Modal
        title="部署模型"
        open={isDeployModalOpen}
        onCancel={() => {
          setIsDeployModalOpen(false);
          deployForm.resetFields();
        }}
        onOk={() => {
          deployForm.validateFields().then((values) => {
            const config: ModelDeploymentConfig = {
              model_id: selectedModel!.model_id,
              resources: {
                gpu_type: values.gpu_type,
                gpu_count: values.gpu_count,
                cpu: values.cpu,
                memory: values.memory,
              },
              parameters: {
                max_model_len: values.max_model_len,
              },
              replicas: values.replicas,
            };
            deployMutation.mutate({ modelId: selectedModel!.model_id, config });
          });
        }}
        confirmLoading={deployMutation.isPending}
        width={600}
      >
        <Form form={deployForm} layout="vertical" initialValues={{ gpu_count: 1, replicas: 1, cpu: '4', memory: '16Gi' }}>
          <Form.Item
            label="GPU 类型"
            name="gpu_type"
            rules={[{ required: true, message: '请选择 GPU 类型' }]}
            initialValue="T4"
          >
            <Select>
              <Option value="T4">NVIDIA T4</Option>
              <Option value="V100">NVIDIA V100</Option>
              <Option value="A100">NVIDIA A100</Option>
              <Option value="A10">NVIDIA A10</Option>
              <Option value="A100-80G">NVIDIA A100 80GB</Option>
            </Select>
          </Form.Item>
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                label="GPU 数量"
                name="gpu_count"
                rules={[{ required: true, message: '请输入 GPU 数量' }]}
              >
                <InputNumber min={1} max={8} style={{ width: '100%' }} />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                label="副本数"
                name="replicas"
                rules={[{ required: true, message: '请输入副本数' }]}
              >
                <InputNumber min={1} max={10} style={{ width: '100%' }} />
              </Form.Item>
            </Col>
          </Row>
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                label="CPU"
                name="cpu"
                rules={[{ required: true, message: '请输入 CPU' }]}
              >
                <Input placeholder="4" />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                label="内存"
                name="memory"
                rules={[{ required: true, message: '请输入内存' }]}
              >
                <Input placeholder="16Gi" />
              </Form.Item>
            </Col>
          </Row>
          <Form.Item label="最大模型长度" name="max_model_len">
            <InputNumber min={128} max={32000} style={{ width: '100%' }} placeholder="4096" />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
}

export default AIHubPage;
