# ONE-DATA-STUDIO Web Frontend Nginx Configuration
# 优化版：使用 map 指令统一路由管理

# 后端服务定义
upstream alldata-api {
    server alldata-api:8001;
    keepalive 32;
}

upstream bisheng-api {
    server bisheng-api:8000;
    keepalive 32;
}

upstream cube-api {
    server cube-api:8002;
    keepalive 32;
}

upstream openai-proxy {
    server openai-proxy:8000;
    keepalive 32;
}

upstream keycloak {
    server keycloak:8080;
    keepalive 32;
}

upstream admin-api {
    server admin-api:8004;
    keepalive 32;
}

# API 路由映射：根据路径前缀选择后端服务
map $request_uri $backend {
    # Keycloak paths
    ~^/auth/                      "keycloak";
    ~^/resources/                 "keycloak";
    ~^/js/                        "keycloak";
    ~^/realms/                    "keycloak";

    # OpenAI Proxy (LLM inference)
    ~^/v1/(chat|models|embeddings|completions)  "openai-proxy";

    # Admin API (优先级最高，放在前面)
    ~^/api/v1/(users|groups|roles|permissions)(/|$)              "admin-api";
    ~^/api/v1/notification-(channels|templates|logs)(/|$)        "admin-api";
    ~^/api/v1/notifications(/|$)                                "admin-api";
    ~^/api/v1/(admin|audit|stats|cost|portal)(/|$)              "admin-api";

    # Alldata API (数据治理)
    ~^/api/v1/(datasets|datasources|metadata|query)(/|$)         "alldata-api";
    ~^/api/v1/features(-groups|-sets|-services)?(/|$)            "alldata-api";
    ~^/api/v1/(standards|assets|services|bi|metrics)(/|$)        "alldata-api";
    ~^/api/v1/(etl|quality|lineage|flink)(/|$)                  "alldata-api";
    ~^/api/v1/(data-monitoring|offline|streaming)(/|$)          "alldata-api";
    ~^/api/v1/(notebooks|kettle|ocr|alerts|health)(/|$)         "alldata-api";

    # Cube API (MLOps)
    ~^/api/v1/cube(/|$)                                         "cube-api";
    ~^/api/v1/(training|pipelines|experiments)(/|$)             "cube-api";
    ~^/api/v1/(llm|hub|aihub|resources|serving|monitoring)(/|$) "cube-api";
    ~^/api/v1/models/registered                                 "cube-api";

    # Bisheng API (LLMOps - 默认 fallback)
    ~^/api/                                                     "bisheng-api";

    # 默认后端
    default                                                     "bisheng-api";
}

# 根据 backend 名称选择实际的上游服务器
map $backend $upstream_server {
    "alldata-api"    "alldata-api";
    "bisheng-api"    "bisheng-api";
    "cube-api"       "cube-api";
    "openai-proxy"   "openai-proxy";
    "admin-api"      "admin-api";
    "keycloak"       "keycloak";
}

# SSE 流式响应的特殊路径
map $request_uri $is_sse_stream {
    ~^/v1/chat                       1;
    ~^/v1/chat/completions           1;
    ~^/v1/completions                1;
    default                          0;
}

server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # 启用 gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 静态资源缓存（仅限 /assets/ 目录）
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 统一 API 代理（使用动态路由）
    location / {
        # Keycloak 路径特殊处理（需要路径重写）
        if ($backend = "keycloak") {
            rewrite ^/auth/(.*)$ /$1 break;
            rewrite ^/resources/(.*)$ /resources/$1 break;
            rewrite ^/js/(.*)$ /js/$1 break;
            rewrite ^/realms/(.*)$ /realms/$1 break;
            proxy_pass http://keycloak;
            break;
        }

        # OpenAI Proxy 特殊处理（SSE 支持）
        if ($is_sse_stream = 1) {
            proxy_pass http://openai-proxy;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";

            # SSE 支持
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            break;
        }

        # 健康检查端点
        if ($request_uri = /health) {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
            break;
        }

        # API 请求代理到对应的后端
        if ($backend != "") {
            proxy_pass http://$upstream_server;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            break;
        }

        # SPA 路由支持（静态文件）
        try_files $uri $uri/ /index.html;
    }

    # 显式健康检查端点
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
